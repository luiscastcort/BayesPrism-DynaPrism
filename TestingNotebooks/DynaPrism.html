<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DynaPrism</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="DynaPrism_files/libs/clipboard/clipboard.min.js"></script>
<script src="DynaPrism_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="DynaPrism_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="DynaPrism_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="DynaPrism_files/libs/quarto-html/popper.min.js"></script>
<script src="DynaPrism_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="DynaPrism_files/libs/quarto-html/anchor.min.js"></script>
<link href="DynaPrism_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="DynaPrism_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="DynaPrism_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="DynaPrism_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="DynaPrism_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DynaPrism</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="environment-set-up" class="level1">
<h1>0. Environment Set-Up</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(snowfall)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'snowfall' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: snow</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gplots)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'gplots' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
---------------------
gplots 3.3.0 loaded:
  * Use citation('gplots') for citation info.
  * Homepage: https://talgalili.github.io/gplots/
  * Report issues: https://github.com/talgalili/gplots/issues
  * Ask questions: https://stackoverflow.com/questions/tagged/gplots
  * Suppress this message with: suppressPackageStartupMessages(library(gplots))
---------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'gplots'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    lowess</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BiocParallel)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'BiocParallel' was built under R version 4.5.2</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scran)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scran' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: SingleCellExperiment</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'SingleCellExperiment' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: SummarizedExperiment</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'SummarizedExperiment' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MatrixGenerics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'MatrixGenerics' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: matrixStats</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MatrixGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:matrixStats':

    colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,
    colCounts, colCummaxs, colCummins, colCumprods, colCumsums,
    colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,
    colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,
    colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,
    colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,
    colWeightedMeans, colWeightedMedians, colWeightedSds,
    colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,
    rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,
    rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,
    rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,
    rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,
    rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,
    rowWeightedMads, rowWeightedMeans, rowWeightedMedians,
    rowWeightedSds, rowWeightedVars</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: GenomicRanges</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'GenomicRanges' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: stats4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: BiocGenerics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'BiocGenerics' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: generics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'generics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    as.difftime, as.factor, as.ordered, intersect, is.element, setdiff,
    setequal, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'BiocGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    IQR, mad, sd, var, xtabs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    anyDuplicated, aperm, append, as.data.frame, basename, cbind,
    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,
    get, grep, grepl, is.unsorted, lapply, Map, mapply, match, mget,
    order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,
    rbind, Reduce, rownames, sapply, saveRDS, table, tapply, unique,
    unsplit, which.max, which.min</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: S4Vectors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'S4Vectors' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'S4Vectors'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:gplots':

    space</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    findMatches</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    expand.grid, I, unname</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: IRanges</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'IRanges' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'IRanges'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:grDevices':

    windows</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Seqinfo</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Seqinfo' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Biobase</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Biobase' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Welcome to Bioconductor

    Vignettes contain introductory material; view with
    'browseVignettes()'. To cite Bioconductor, see
    'citation("Biobase")', and for packages 'citation("pkgname")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Biobase'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:MatrixGenerics':

    rowMedians</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:matrixStats':

    anyMissing, rowMedians</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: scuttle</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scuttle' was built under R version 4.5.2</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(utils)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(NMF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'NMF' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: registry</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'registry' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rngtools</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rngtools' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: cluster</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>NMF - BioConductor layer [OK] | Shared memory capabilities [NO: windows] | Cores 2/2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'NMF'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    nrun</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:generics':

    fit</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:BiocParallel':

    register</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Matrix' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    expand</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SingleCellExperiment)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggalign)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggalign' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>========================================
ggalign version 1.2.0

If you use it in published research, please cite: 
Peng, Y.; Jiang, S.; Song, Y.; et al. ggalign: Bridging the Grammar of Graphics and Biological Multilayered Complexity. Advanced Science. 2025. doi:10.1002/advs.202507799
========================================</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'ggalign'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:IRanges':

    active</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    active</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(colorspace)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'colorspace' was built under R version 4.5.2</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/classes.R"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/new_prism.R"</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/run_prism.R"</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/run_gibbs.R"</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/JointPost_functions.R"</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/update_reference.R"</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/optim_functions_MAP.R"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/Omega_tensor.R"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"../data/"</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.exists</span>(data_dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="loading-data" class="level1">
<h1>1. Loading Data</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>blk <span class="ot">&lt;-</span> DeconvoBuddies<span class="sc">::</span><span class="fu">fetch_deconvo_data</span>(<span class="st">"rse_gene"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"sce.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Getting lists of cell types and cell states.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>sce<span class="sc">$</span>cellType_hc <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(sce<span class="sc">$</span>cellType_hc)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>sce<span class="sc">$</span>cellType_broad_hc <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(sce<span class="sc">$</span>cellType_broad_hc)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>cell_types <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.vector</span>(sce<span class="sc">$</span>cellType_broad_hc))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>cell_states <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.vector</span>(sce<span class="sc">$</span>cellType_hc))</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>type_to_state <span class="ot">&lt;-</span> <span class="fu">lapply</span>(cell_types,<span class="cf">function</span>(t)<span class="fu">unique</span>(<span class="fu">as.vector</span>(sce<span class="sc">$</span>cellType_hc[sce<span class="sc">$</span>cellType_broad_hc<span class="sc">==</span>t])))</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(type_to_state) <span class="ot">&lt;-</span> cell_types</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>state_to_type <span class="ot">&lt;-</span> <span class="fu">stack</span>(type_to_state)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(state_to_type) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"cell_type"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Color dictionaries for graphs</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>type_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Inhib =</span> <span class="st">"#369acc"</span>, </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Oligo =</span> <span class="st">"#f8e16f"</span>, </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">OPC =</span> <span class="st">"#6c584c"</span>, </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Excit =</span> <span class="st">"#95cf92"</span>, </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Astro =</span> <span class="st">"#9656a2"</span>, </span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">EndoMural =</span> <span class="st">"#f4895f"</span>, </span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Micro =</span> <span class="st">"#de324c"</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co">#type_colors &lt;- setNames(brewer.pal(length(type_to_state), "Set3"), names(type_to_state))</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>state_colors <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">names</span>(type_to_state), <span class="cf">function</span>(ct) {</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  states <span class="ot">&lt;-</span> type_to_state[[ct]]</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(states)</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  base <span class="ot">&lt;-</span> type_colors[ct]</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(<span class="fu">setNames</span>(base, states))</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>  pal_func <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lighten</span>(base, <span class="fl">0.3</span>), </span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    base, </span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">darken</span>(base, <span class="fl">0.3</span>)</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">setNames</span>(<span class="fu">pal_func</span>(n), states))</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a><span class="co">#scales::show_col(type_colors)</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a><span class="co">#scales::show_col(state_colors)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="omega-tensor" class="level1">
<h1>2. Omega tensor</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"Omega.rdata"</span>))</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"Weighted_Omega.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bayesprism" class="level1">
<h1>2. BayesPrism</h1>
<section id="new-prism" class="level2">
<h2 class="anchored" data-anchor-id="new-prism">2.1 New Prism</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>br_num <span class="ot">=</span> <span class="st">"Br2720"</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>position <span class="ot">=</span> <span class="st">"post"</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">=</span> <span class="fu">paste0</span>(br_num,<span class="st">"_"</span>,position)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(blk) <span class="ot">&lt;-</span> <span class="fu">rowData</span>(blk)<span class="sc">$</span>Symbol</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co">#blk_sample = blk[intersect(rownames(sce), rownames(blk)),blk$Sample==sample]</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>myPrism <span class="ot">&lt;-</span> <span class="fu">new.prism</span>(</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference=</span><span class="fu">t</span>(<span class="fu">as.matrix</span>(<span class="fu">counts</span>(sce))), </span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture=</span><span class="fu">t</span>(<span class="fu">assay</span>(blk)),</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">input.type=</span><span class="st">"count.matrix"</span>, </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell.type.labels =</span> sce<span class="sc">$</span>cellType_broad_hc, </span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell.state.labels =</span> sce<span class="sc">$</span>cellType_hc,</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">key =</span> <span class="cn">NULL</span>,</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">outlier.cut=</span><span class="fl">0.01</span>,</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.fraction=</span><span class="fl">0.1</span>,</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(myPrism, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"myPrism_"</span>, sample, <span class="st">".rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"myPrism_"</span>, sample, <span class="st">".rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="run-bayesprism" class="level2">
<h2 class="anchored" data-anchor-id="run-bayesprism">2.2 Run BayesPrism</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>bp_res <span class="ot">&lt;-</span> <span class="fu">run.prism</span>(<span class="at">prism =</span> myPrism, <span class="at">n.cores=</span><span class="dv">14</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(bp_res, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"bp_res_"</span>, sample, <span class="st">".rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"bp_res_"</span>, sample, <span class="st">".rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="functions" class="level3">
<h3 class="anchored" data-anchor-id="functions">2.2.1 Functions</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' An S4 class to represent the input, X, phi; alpha and controls of Gibbs sampling </span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot phi an array of dimension K*G to denote reference matrix</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot X a matrix of dimension N*G to denote bulk matrix</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot theta a matrix of dimension K*N to denote the cell type fraction in each bulk</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot alpha a numeric value to denote the symmetric Dirichlet prior, fixed to 1E-8 </span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot gibbs.control a list containing parameters of the Gibbs sampler</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="fu">setClass</span>(<span class="st">"gibbsSamplerOmega"</span>,</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">slots =</span> <span class="fu">c</span>(</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference =</span> <span class="st">"reference"</span>,</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">X =</span> <span class="st">"matrix"</span>,</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">Omega =</span> <span class="st">"array"</span>,</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">gibbs.control =</span> <span class="st">"list"</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">prototype =</span> <span class="fu">list</span>(</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference =</span> <span class="cn">NULL</span>,</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">X =</span> <span class="fu">matrix</span>(),</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">gibbs.control =</span> <span class="fu">list</span>(<span class="at">chain.length =</span> <span class="cn">NULL</span>,</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>                                <span class="at">burn.in =</span> <span class="cn">NULL</span>,</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>                                <span class="at">thinning =</span> <span class="cn">NULL</span>,</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.cores =</span> <span class="cn">NULL</span>,</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>                                <span class="at">seed =</span> <span class="cn">NULL</span>,</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>                                <span class="at">alpha =</span> <span class="cn">NULL</span>, </span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>                                <span class="at">beta =</span> <span class="cn">NULL</span>)</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">validity =</span> <span class="cf">function</span>(object){</span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>            errors <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is</span>(object<span class="sc">@</span>reference, <span class="st">"refPhi"</span>))</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>                ref.gene <span class="ot">&lt;-</span> <span class="fu">colnames</span>(object<span class="sc">@</span>reference<span class="sc">@</span>phi)</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is</span>(object<span class="sc">@</span>reference, <span class="st">"refTumor"</span>))</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>                ref.gene <span class="ot">&lt;-</span> <span class="fu">colnames</span>(object<span class="sc">@</span>reference<span class="sc">@</span>psi_mal)</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(ref.gene, <span class="fu">colnames</span>(object<span class="sc">@</span>X))){</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>                msg <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Gene names do not match"</span>)</span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>                errors <span class="ot">&lt;-</span> <span class="fu">c</span>(errors, msg)</span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>                                                        </span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">length</span>(errors) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">TRUE</span> <span class="cf">else</span> errors</span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' An S4 class to represent the output of run.prism</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot input.initial.cellState an S4 object of class gibbsSampler </span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the input of initial Gibbs sampling over cell states </span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot posterior.initial.cellState an S4 object of class jointPost </span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the results of initial Gibbs sampling over cell states</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot posterior.initial.cellType an S4 object of class jointPost </span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the results over cell types merged from posterior.initial.cellState</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot reference.update an S4 object of class reference </span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the updated reference</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot posterior.theta_f matrix to represent the cell type fraction from the final Gibbs sampling</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot control_param a list to store all </span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="fu">setClass</span>(<span class="st">"BayesPrismOmega"</span>,</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">slots =</span> <span class="fu">c</span>(</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">prism =</span> <span class="st">"prism"</span>,</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">Omega =</span> <span class="st">"array"</span>,</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellState =</span> <span class="st">"jointPost"</span>,</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellType =</span> <span class="st">"jointPost"</span>,</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference.update =</span> <span class="st">"reference"</span>,</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.theta_f =</span> <span class="st">"theta_f"</span>,</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">control_param =</span> <span class="st">"list"</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">prototype =</span> <span class="fu">list</span>(</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">prism =</span> <span class="fu">new</span>(<span class="st">"prism"</span>),</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellState =</span> <span class="fu">new</span>(<span class="st">"jointPost"</span>),</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellType =</span> <span class="fu">new</span>(<span class="st">"jointPost"</span>),</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference.update =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.theta_f =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">control_param =</span> <span class="fu">list</span>(<span class="at">gibbs.control =</span> <span class="fu">list</span>(<span class="at">chain.length =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">burn.in =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">thinning =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n.cores =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">seed =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">alpha=</span><span class="cn">NULL</span>,</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">beta =</span> <span class="cn">NULL</span>),</span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">opt.control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="cn">NULL</span>, </span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">maxit =</span> <span class="cn">NULL</span>,</span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">optimizer =</span> <span class="cn">NA_character_</span>, </span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">n.cores =</span> <span class="cn">NULL</span>),</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">map =</span> <span class="fu">list</span>(),</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">key =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">update.gibbs =</span> <span class="fu">logical</span>())</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to validate gibbs.control</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param control a named list of parameters required to control optimization  </span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>valid.gibbs.control.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(control){</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">chain.length=</span><span class="dv">1000</span>, <span class="at">burn.in=</span><span class="dv">500</span>, <span class="at">thinning=</span><span class="dv">2</span>, <span class="at">n.cores=</span><span class="dv">1</span>, <span class="at">seed=</span><span class="dv">123</span>, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">beta =</span> <span class="fl">0.4</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    namc <span class="ot">&lt;-</span> <span class="fu">names</span>(control)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(namc <span class="sc">%in%</span> <span class="fu">names</span>(ctrl)))</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"unknown names in gibbs.control: "</span>, namc[<span class="sc">!</span>(namc <span class="sc">%in%</span> <span class="fu">names</span>(ctrl))])</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    ctrl[namc] <span class="ot">&lt;-</span> control</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(ctrl<span class="sc">$</span>alpha <span class="sc">&lt;</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"alpha needs to be positive"</span>)</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ctrl<span class="sc">$</span>beta <span class="sc">&lt;</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"beta needs to be positive"</span>)</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(ctrl)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' main function to run deconvolution using BayesPrism</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n.cores number of cores to use. Default =1.</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'      If needs to set different number of cores for Gibbs sampling and optimization,</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'      supply n.cores in gibbs.control and/or opt.control</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param update.gibbs a logical variable to denote whether run final Gibbs sampling to update theta</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbs.control a list containing parameters of the Gibbs sampler</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'      chain.length: length of MCMC chain. Default=1000;</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'      burn.in: length of burn in period. Default=500;</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'      thinning: retain every # of MCMC samples after the burn in period to reduce auto-correlation. Default=2;</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'      n.cores: number of cores to use. Default uses n.cores in the main argument.</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'      seed: seed number to use for repoducibility. Default = 123. set to NULL if use pseudo random.</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'      alpha: a numeric vector to represent the parameter of dirichlet distribution. Default=1. (1E-8 may yield theta=0 due to underflow. causes issue when psuedo.min=0) </span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'      beta: a numeric vector to represent the strength of the interatcion term</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param opt.control a list containing parameters for the optimization step:</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'      maxit: maximum number of cycles to interate. Default=100000</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="co">#'      sigma: hyper-parameter of the prior if optimizer="MAP". Default=2.</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'      optimizer a character string to denote which algorithm to use</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'          "MAP": the one used by the BayesPrism paper, with cell type-specific gamma under a log-normal prior </span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'          "MLE": the new algorithm that models a single gamma across cell types. Useful when some cell types are low in Z_k, e.g. spatial data</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="co">#'          default to "MAP"</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>run.prism.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(prism,</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>                            Omega,</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>                            <span class="at">n.cores=</span><span class="dv">1</span>,</span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>                            <span class="at">update.gibbs=</span><span class="cn">TRUE</span>,</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gibbs.control=</span><span class="fu">list</span>(),</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">opt.control=</span><span class="fu">list</span>()</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>                            ){</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span> <span class="st">"n.cores"</span> <span class="sc">%in%</span> <span class="fu">names</span>(gibbs.control)) gibbs.control<span class="sc">$</span>n.cores <span class="ot">&lt;-</span> n.cores</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span> <span class="st">"n.cores"</span> <span class="sc">%in%</span> <span class="fu">names</span>(opt.control)) opt.control<span class="sc">$</span>n.cores <span class="ot">&lt;-</span> n.cores</span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(update.gibbs) <span class="sc">&amp;</span> <span class="fu">length</span>(update.gibbs)<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(n.cores) <span class="sc">&amp;</span> <span class="fu">length</span>(n.cores)<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>    opt.control <span class="ot">&lt;-</span> <span class="fu">valid.opt.control</span>(opt.control)</span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> <span class="fu">valid.gibbs.control.Omega</span>(gibbs.control)</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(prism<span class="sc">@</span>phi_cellState<span class="sc">@</span>pseudo.min<span class="sc">==</span><span class="dv">0</span>) </span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a>        gibbs.control<span class="sc">$</span>alpha <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, gibbs.control<span class="sc">$</span>alpha)</span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#write mixture to disk and load each X_n to the corresponding node to save memory</span></span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>    tmp.dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>(<span class="at">check=</span><span class="cn">TRUE</span>)</span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(prism<span class="sc">@</span>mixture)) {</span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a>        X_n <span class="ot">&lt;-</span> prism<span class="sc">@</span>mixture[n,]</span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>        file.name <span class="ot">&lt;-</span> <span class="fu">paste</span>(tmp.dir, <span class="st">"/mixture_"</span>,n,<span class="st">".rdata"</span>,<span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">save</span>(X_n, <span class="at">file=</span> file.name)</span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sampling cell states (cs)</span></span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>    gibbsSampler.ini.cs <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"gibbsSamplerOmega"</span>,</span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>                                <span class="at">reference =</span> prism<span class="sc">@</span>phi_cellState,</span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>                                <span class="at">X =</span> prism<span class="sc">@</span>mixture,</span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a>                                <span class="at">Omega =</span> Omega,</span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>                                <span class="at">gibbs.control =</span> gibbs.control)</span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>    jointPost.ini.cs <span class="ot">&lt;-</span> <span class="fu">run.gibbs.Omega</span>(gibbsSampler.ini.cs, Omega,</span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">final=</span><span class="cn">FALSE</span>)</span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#merge over cell states to get cell type (ct) info</span></span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a>    jointPost.ini.ct <span class="ot">&lt;-</span> <span class="fu">mergeK</span>(<span class="at">jointPost.obj =</span> jointPost.ini.cs, </span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">map =</span> prism<span class="sc">@</span>map)</span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>update.gibbs) <span class="co">#only do initial Gibbs sampling</span></span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a>        bp.obj <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"BayesPrismOmega"</span>,</span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prism =</span> prism,</span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Omega =</span> Omega,</span>
<span id="cb96-67"><a href="#cb96-67" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellState =</span> jointPost.ini.cs,</span>
<span id="cb96-68"><a href="#cb96-68" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellType =</span> jointPost.ini.ct,</span>
<span id="cb96-69"><a href="#cb96-69" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_param =</span> <span class="fu">list</span>(<span class="at">gibbs.control =</span> gibbs.control, </span>
<span id="cb96-70"><a href="#cb96-70" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">opt.control =</span> opt.control,</span>
<span id="cb96-71"><a href="#cb96-71" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">update.gibbs =</span> update.gibbs)</span>
<span id="cb96-72"><a href="#cb96-72" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb96-73"><a href="#cb96-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb96-74"><a href="#cb96-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">#contruct the new gibbsSampler object with updated reference</span></span>
<span id="cb96-75"><a href="#cb96-75" aria-hidden="true" tabindex="-1"></a>        psi <span class="ot">&lt;-</span> <span class="fu">updateReference</span> (<span class="at">Z =</span> jointPost.ini.ct<span class="sc">@</span>Z,</span>
<span id="cb96-76"><a href="#cb96-76" aria-hidden="true" tabindex="-1"></a>                                <span class="at">phi_prime =</span> prism<span class="sc">@</span>phi_cellType,</span>
<span id="cb96-77"><a href="#cb96-77" aria-hidden="true" tabindex="-1"></a>                                <span class="at">map =</span> prism<span class="sc">@</span>map,</span>
<span id="cb96-78"><a href="#cb96-78" aria-hidden="true" tabindex="-1"></a>                                <span class="at">key =</span> prism<span class="sc">@</span>key,</span>
<span id="cb96-79"><a href="#cb96-79" aria-hidden="true" tabindex="-1"></a>                                <span class="at">opt.control =</span> opt.control)</span>
<span id="cb96-80"><a href="#cb96-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-81"><a href="#cb96-81" aria-hidden="true" tabindex="-1"></a>        gibbsSampler.update <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"gibbsSampler"</span>,</span>
<span id="cb96-82"><a href="#cb96-82" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">reference =</span> psi,</span>
<span id="cb96-83"><a href="#cb96-83" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X =</span> prism<span class="sc">@</span>mixture,</span>
<span id="cb96-84"><a href="#cb96-84" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">gibbs.control =</span> gibbs.control)</span>
<span id="cb96-85"><a href="#cb96-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-86"><a href="#cb96-86" aria-hidden="true" tabindex="-1"></a>        theta_f <span class="ot">&lt;-</span> <span class="fu">run.gibbs</span>(gibbsSampler.update, </span>
<span id="cb96-87"><a href="#cb96-87" aria-hidden="true" tabindex="-1"></a>                             <span class="at">final=</span><span class="cn">TRUE</span>)</span>
<span id="cb96-88"><a href="#cb96-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-89"><a href="#cb96-89" aria-hidden="true" tabindex="-1"></a>        bp.obj <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"BayesPrismOmega"</span>,</span>
<span id="cb96-90"><a href="#cb96-90" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prism =</span> prism,</span>
<span id="cb96-91"><a href="#cb96-91" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Omega =</span> Omega,</span>
<span id="cb96-92"><a href="#cb96-92" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellState =</span> jointPost.ini.cs,</span>
<span id="cb96-93"><a href="#cb96-93" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellType =</span> jointPost.ini.ct,</span>
<span id="cb96-94"><a href="#cb96-94" aria-hidden="true" tabindex="-1"></a>                      <span class="at">reference.update =</span> psi,</span>
<span id="cb96-95"><a href="#cb96-95" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.theta_f =</span> theta_f,</span>
<span id="cb96-96"><a href="#cb96-96" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_param =</span> <span class="fu">list</span>(<span class="at">gibbs.control =</span> gibbs.control, </span>
<span id="cb96-97"><a href="#cb96-97" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">opt.control =</span> opt.control,</span>
<span id="cb96-98"><a href="#cb96-98" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">update.gibbs =</span> update.gibbs)</span>
<span id="cb96-99"><a href="#cb96-99" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb96-100"><a href="#cb96-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-101"><a href="#cb96-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-102"><a href="#cb96-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlink</span>(tmp.dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-103"><a href="#cb96-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-104"><a href="#cb96-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(bp.obj)      </span>
<span id="cb96-105"><a href="#cb96-105" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function used to estimate run time of Gibbs sampling (print to console)</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj a gibbsSampler object</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param final a logical variable denote whether report only updated theta_f (final =TRUE)</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param chain.length length of MCMC chain used to simulate. Default=50.</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>estimate.gibbs.time.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj,</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>                                final, </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">chain.length=</span><span class="dv">50</span>){</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    ref <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>reference</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>X</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>gibbs.control</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>final){</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#initial Gibbs</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample.Z.theta_n.Omega</span> (<span class="at">X_n =</span> X[<span class="dv">1</span>,], </span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">phi =</span> ref<span class="sc">@</span>phi, </span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">alpha =</span> gibbs.control<span class="sc">$</span>alpha,</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Omega =</span> gibbsSampler.obj<span class="sc">@</span>Omega,</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">beta =</span> gibbs.control<span class="sc">$</span>beta,</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">gibbs.idx =</span> <span class="fu">get.gibbs.idx</span>(</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">list</span>(<span class="at">chain.length =</span> chain.length, </span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">burn.in =</span> chain.length<span class="sc">*</span>gibbs.control<span class="sc">$</span>burn.in<span class="sc">/</span>gibbs.control<span class="sc">$</span>chain.length,</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">thinning =</span> gibbs.control<span class="sc">$</span>thinning)</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>                                  )</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>                           )</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">#updated Gibbs</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is</span>(ref,<span class="st">"refPhi"</span>)){</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.theta_n</span> (<span class="at">X_n =</span> X[<span class="dv">1</span>,], </span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>                            <span class="at">phi =</span> ref<span class="sc">@</span>phi, </span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> gibbs.control<span class="sc">$</span>alpha,</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gibbs.idx =</span> <span class="fu">get.gibbs.idx</span>(</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">list</span>(<span class="at">chain.length =</span> chain.length, </span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">burn.in =</span> chain.length<span class="sc">*</span>gibbs.control<span class="sc">$</span>burn.in<span class="sc">/</span>gibbs.control<span class="sc">$</span>chain.length,</span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">thinning =</span> gibbs.control<span class="sc">$</span>thinning)</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>                                 )</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>                                )</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is</span>(ref,<span class="st">"refTumor"</span>)){</span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>            phi_1 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(ref<span class="sc">@</span>psi_mal[<span class="dv">1</span>,], ref<span class="sc">@</span>psi_env)</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>            nonzero.idx <span class="ot">&lt;-</span> <span class="fu">apply</span>(phi_1,<span class="dv">2</span>,max)<span class="sc">&gt;</span><span class="dv">0</span></span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.theta_n</span> (<span class="at">X_n =</span> X[<span class="dv">1</span>,nonzero.idx, <span class="at">drop=</span>F], </span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>                            <span class="at">phi =</span> phi_1[, nonzero.idx, <span class="at">drop=</span>F], </span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> gibbs.control<span class="sc">$</span>alpha,</span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gibbs.idx =</span> <span class="fu">get.gibbs.idx</span>(</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">list</span>(<span class="at">chain.length =</span> chain.length, </span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">burn.in =</span> chain.length<span class="sc">*</span>gibbs.control<span class="sc">$</span>burn.in<span class="sc">/</span>gibbs.control<span class="sc">$</span>chain.length,</span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">thinning =</span> gibbs.control<span class="sc">$</span>thinning)</span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>                                )</span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>                                )   </span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>        }   </span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>    total.time <span class="ot">&lt;-</span> <span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>    total.time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(total.time[<span class="st">"elapsed"</span>])</span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># seems to underestimate when transferring data comsumes large amount of time (spatial data)</span></span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>    estimated.time <span class="ot">&lt;-</span> gibbs.control <span class="sc">$</span>chain.length <span class="sc">/</span> chain.length <span class="sc">*</span> total.time <span class="sc">*</span> <span class="fu">ceiling</span>(<span class="fu">nrow</span>(X) <span class="sc">/</span> gibbs.control<span class="sc">$</span>n.cores) <span class="sc">*</span><span class="dv">2</span>         </span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>    current.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Current time: "</span>, <span class="fu">as.character</span>(current.time), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Estimated time to complete: "</span>, <span class="fu">my_seconds_to_period</span>(estimated.time), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Estimated finishing time: "</span>, <span class="fu">as.character</span>(current.time <span class="sc">+</span> estimated.time), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run Gibbs sampling </span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj, a gibbsSampler object</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param final a logical variable denote whether report only updated theta_f (final=TRUE)</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param if.estimate a logical variable denote whether estimate the run time. Default=TRUE</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import snowfall</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a gibbsSampler object with Z and theta entries, if final=FALSE,  or theta_f matrix if final=TRUE</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>run.gibbs.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj, </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>                            Omega,</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>                            final,</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">if.estimate=</span><span class="cn">TRUE</span>,</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">compute.elbo=</span><span class="cn">FALSE</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>                            ){</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(final) <span class="fu">cat</span>(<span class="st">"Run Gibbs sampling using updated reference ... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="fu">cat</span>(<span class="st">"Run Gibbs sampling... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(if.estimate)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">estimate.gibbs.time.Omega</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj, </span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">final =</span> final)</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is</span>(gibbsSampler.obj<span class="sc">@</span>reference,<span class="st">"refPhi"</span>)) {</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span>final) <span class="fu">return</span>(<span class="fu">run.gibbs.refPhi.ini.Omega</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj, </span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">Omega =</span> Omega,</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">compute.elbo =</span> compute.elbo))</span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="fu">return</span>(<span class="fu">run.gibbs.refPhi.final</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj, </span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">compute.elbo =</span> compute.elbo))</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is</span>(gibbsSampler.obj<span class="sc">@</span>reference,<span class="st">"refTumor"</span>)) {</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">run.gibbs.refTumor</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj)) </span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run initial Gibbs sampling if reference is of the class refPhi</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj, a gibbsSampler object</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import snowfall</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a jointPost object with Z and theta entries </span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>run.gibbs.refPhi.ini.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>                                       Omega,</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>                                       compute.elbo){</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>reference<span class="sc">@</span>phi</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>X</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>gibbs.control</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>alpha</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>beta</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    gibbs.idx <span class="ot">&lt;-</span> <span class="fu">get.gibbs.idx</span>(gibbs.control)</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>    seed <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>seed</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>    <span class="do">##### LOOK INTO THESE</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>    sample.Z.theta_n.Omega <span class="ot">&lt;-</span> sample.Z.theta_n.Omega</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>    rdirichlet <span class="ot">&lt;-</span> BayesPrism<span class="sc">:::</span>rdirichlet</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Start run... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(gibbs.control<span class="sc">$</span>n.cores<span class="sc">&gt;</span><span class="dv">1</span>){    </span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">#parallel using snowfall    </span></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfInit</span>(<span class="at">parallel =</span> <span class="cn">TRUE</span>, <span class="at">cpus =</span> gibbs.control<span class="sc">$</span>n.cores, <span class="at">type =</span> <span class="st">"SOCK"</span> )</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>        cpu.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">#load nth mixture from disk</span></span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a>            file.name.X_n <span class="ot">&lt;-</span> <span class="fu">paste</span>(tmp.dir, <span class="st">"/mixture_"</span>,n,<span class="st">".rdata"</span>,<span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">load</span>(file.name.X_n)</span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.Z.theta_n.Omega</span> (<span class="at">X_n =</span> X_n, </span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a>                              <span class="at">phi =</span> phi, </span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a>                              <span class="at">alpha =</span> alpha, </span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Omega =</span> Omega,</span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a>                              <span class="at">beta =</span> beta,</span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a>                              <span class="at">gibbs.idx =</span> gibbs.idx, </span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a>                              <span class="at">compute.elbo =</span> compute.elbo)      </span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a>        tmp.dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>(<span class="at">check=</span><span class="cn">TRUE</span>)</span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfExport</span>(<span class="st">"phi"</span>, <span class="st">"alpha"</span>, <span class="st">"Omega"</span>, <span class="st">"beta"</span>, <span class="st">"gibbs.idx"</span>, <span class="st">"seed"</span>, </span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"compute.elbo"</span>, <span class="st">"sample.Z.theta_n.Omega"</span>,<span class="st">"rdirichlet"</span>,<span class="st">"tmp.dir"</span>)</span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">environment</span>(cpu.fun) <span class="ot">&lt;-</span> <span class="fu">globalenv</span>()</span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a>        gibbs.list <span class="ot">&lt;-</span> <span class="fu">sfLapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), cpu.fun)</span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfStop</span>()</span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">#single thread</span></span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a>        cpu.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(n,<span class="st">" "</span>)</span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sample.Z.theta_n.Omega</span> (<span class="at">X_n =</span> X[n,], </span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">phi =</span> phi,</span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">alpha =</span> alpha, </span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Omega =</span> Omega,</span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">alpha =</span> alpha,</span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">gibbs.idx =</span> gibbs.idx,</span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">compute.elbo =</span> compute.elbo)</span>
<span id="cb99-62"><a href="#cb99-62" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb99-63"><a href="#cb99-63" aria-hidden="true" tabindex="-1"></a>        gibbs.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), cpu.fun)</span>
<span id="cb99-64"><a href="#cb99-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb99-65"><a href="#cb99-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb99-66"><a href="#cb99-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-67"><a href="#cb99-67" aria-hidden="true" tabindex="-1"></a>    jointPost <span class="ot">&lt;-</span> <span class="fu">newJointPost</span>(<span class="at">bulkID =</span> <span class="fu">rownames</span>(X),</span>
<span id="cb99-68"><a href="#cb99-68" aria-hidden="true" tabindex="-1"></a>                              <span class="at">geneID =</span> <span class="fu">colnames</span>(X), </span>
<span id="cb99-69"><a href="#cb99-69" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cellType =</span> <span class="fu">rownames</span>(phi),</span>
<span id="cb99-70"><a href="#cb99-70" aria-hidden="true" tabindex="-1"></a>                              <span class="at">gibbs.list =</span> gibbs.list )</span>
<span id="cb99-71"><a href="#cb99-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(jointPost)</span>
<span id="cb99-72"><a href="#cb99-72" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run Gibbs sampling for Z and theta on each bulk</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_n a numeric vector of reads count of the nth bulk sample</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param phi an array of dimension K*G to denote reference matrix</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alpha a numeric value to denote the symmetric Dirichlet prior </span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbs.idx a numeric vector to denote the index of samples to be retained from MCMC chain</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param compute.elbo a logical variable to denote if compute ELBO. Default=FALSE.</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' return a list containing the posterior mean of Z_n and theta_n</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>sample.Z.theta_n.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(X_n, </span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>                                 phi,</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>                                alpha,</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                                Omega, </span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>                                beta,</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>                                gibbs.idx,</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>                                <span class="at">compute.elbo=</span><span class="cn">FALSE</span>){</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Setting up Omega implementatiom</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    K_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(phi) <span class="co"># # of Sender States</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    S_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(phi) <span class="co"># # of Receiver States</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>    G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(phi) <span class="co"># # of Genes</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>    G_shared_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(phi) <span class="sc">%in%</span> <span class="fu">dimnames</span>(Omega)<span class="sc">$</span>Gene)</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>    K_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(K_names)</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>    S_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(S_names)</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>    G_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(G_names)</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>    theta_n.i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>S_dim, S_dim)</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>    Z_n.i <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>,<span class="fu">c</span>(G_dim,S_dim))</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>    Z_n.sum <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>,<span class="fu">c</span>(G_dim,S_dim))</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>    theta_n.sum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S_dim)</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>    theta_n2.sum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S_dim)</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#variable for computing ELBO</span></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>    multinom.coef <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>    phi_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(phi)</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>    X_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X_n[G_names])</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Making Omega flat</span></span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>    Omega_flat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Omega[K_names, S_names, G_shared_idx], <span class="at">nrow =</span> S_dim, <span class="at">ncol =</span> S_dim <span class="sc">*</span> <span class="fu">length</span>(G_shared_idx))</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(gibbs.idx)){</span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>      niche_pressure_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(theta_n.i <span class="sc">%*%</span> Omega_flat)</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>      niche_pressure_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(niche_pressure_vec, <span class="at">nrow =</span> S_dim, <span class="at">ncol =</span> <span class="fu">length</span>(G_shared_idx))</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>      niche_pressure_mat <span class="ot">&lt;-</span> (niche_pressure_mat) <span class="sc">/</span> <span class="fu">sd</span>(niche_pressure_mat)</span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">#sample Z for patient n</span></span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>      prob.mat <span class="ot">&lt;-</span> (phi_mat <span class="sc">*</span> theta_n.i)</span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a>      prob.mat[,G_shared_idx] <span class="ot">&lt;-</span> prob.mat[,G_shared_idx] <span class="sc">*</span> <span class="fu">exp</span>(beta <span class="sc">*</span> niche_pressure_mat)</span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>G_dim) {</span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>        Z_n.i[g,] <span class="ot">&lt;-</span> <span class="fu">rmultinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> X_vec[g], <span class="at">prob =</span> prob.mat[, g])</span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb100-56"><a href="#cb100-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample theta for patient n</span></span>
<span id="cb100-57"><a href="#cb100-57" aria-hidden="true" tabindex="-1"></a>        Z_nk.i <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Z_n.i) <span class="co">#total count for each cell type</span></span>
<span id="cb100-58"><a href="#cb100-58" aria-hidden="true" tabindex="-1"></a>        theta_n.i <span class="ot">&lt;-</span> <span class="fu">rdirichlet</span>(<span class="at">alpha =</span> Z_nk.i <span class="sc">+</span> alpha)</span>
<span id="cb100-59"><a href="#cb100-59" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb100-60"><a href="#cb100-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i <span class="sc">%in%</span> gibbs.idx) {</span>
<span id="cb100-61"><a href="#cb100-61" aria-hidden="true" tabindex="-1"></a>            <span class="co">#collect sample and compute posterior sum</span></span>
<span id="cb100-62"><a href="#cb100-62" aria-hidden="true" tabindex="-1"></a>            Z_n.sum <span class="ot">&lt;-</span> Z_n.sum <span class="sc">+</span> Z_n.i</span>
<span id="cb100-63"><a href="#cb100-63" aria-hidden="true" tabindex="-1"></a>            theta_n.sum <span class="ot">&lt;-</span> theta_n.sum <span class="sc">+</span> theta_n.i</span>
<span id="cb100-64"><a href="#cb100-64" aria-hidden="true" tabindex="-1"></a>            theta_n2.sum <span class="ot">&lt;-</span> theta_n2.sum <span class="sc">+</span> theta_n.i<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb100-65"><a href="#cb100-65" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb100-66"><a href="#cb100-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(compute.elbo){</span>
<span id="cb100-67"><a href="#cb100-67" aria-hidden="true" tabindex="-1"></a>                <span class="co"># multinom.coef.i &lt;- sum((alpha-1) * log(theta_n.i), na.rm=TRUE) + </span></span>
<span id="cb100-68"><a href="#cb100-68" aria-hidden="true" tabindex="-1"></a>                                   <span class="co"># sum(Z_nk.i * log(theta_n.i), na.rm=TRUE) - </span></span>
<span id="cb100-69"><a href="#cb100-69" aria-hidden="true" tabindex="-1"></a>                                   <span class="co"># sum(lfactorial(Z_nk.i)) - sum(lfactorial(Z_n.i))</span></span>
<span id="cb100-70"><a href="#cb100-70" aria-hidden="true" tabindex="-1"></a>                multinom.coef.i <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">lfactorial</span>(Z_nk.i)) <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">lfactorial</span>(Z_n.i))</span>
<span id="cb100-71"><a href="#cb100-71" aria-hidden="true" tabindex="-1"></a>                multinom.coef <span class="ot">&lt;-</span> multinom.coef <span class="sc">+</span> multinom.coef.i</span>
<span id="cb100-72"><a href="#cb100-72" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb100-73"><a href="#cb100-73" aria-hidden="true" tabindex="-1"></a>            }   </span>
<span id="cb100-74"><a href="#cb100-74" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb100-75"><a href="#cb100-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb100-76"><a href="#cb100-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>((i <span class="sc">%%</span> <span class="dv">50</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">gc</span>()</span>
<span id="cb100-77"><a href="#cb100-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-78"><a href="#cb100-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-79"><a href="#cb100-79" aria-hidden="true" tabindex="-1"></a>    samples.size <span class="ot">&lt;-</span> <span class="fu">length</span>(gibbs.idx)</span>
<span id="cb100-80"><a href="#cb100-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">#gibbs.constant &lt;- multinom.coef + z.logtheta + theta.dirichlet.alpha</span></span>
<span id="cb100-81"><a href="#cb100-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-82"><a href="#cb100-82" aria-hidden="true" tabindex="-1"></a>    Z_n <span class="ot">&lt;-</span> Z_n.sum <span class="sc">/</span> samples.size</span>
<span id="cb100-83"><a href="#cb100-83" aria-hidden="true" tabindex="-1"></a>    theta_n <span class="ot">&lt;-</span> theta_n.sum <span class="sc">/</span> samples.size</span>
<span id="cb100-84"><a href="#cb100-84" aria-hidden="true" tabindex="-1"></a>    theta.cv_n <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(theta_n2.sum <span class="sc">/</span> samples.size <span class="sc">-</span> (theta_n<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">/</span> theta_n</span>
<span id="cb100-85"><a href="#cb100-85" aria-hidden="true" tabindex="-1"></a>    gibbs.constant <span class="ot">&lt;-</span> multinom.coef <span class="sc">/</span> samples.size</span>
<span id="cb100-86"><a href="#cb100-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb100-87"><a href="#cb100-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Z_n =</span> Z_n, </span>
<span id="cb100-88"><a href="#cb100-88" aria-hidden="true" tabindex="-1"></a>                <span class="at">theta_n =</span> theta_n,</span>
<span id="cb100-89"><a href="#cb100-89" aria-hidden="true" tabindex="-1"></a>                <span class="at">theta.cv_n =</span> theta.cv_n,</span>
<span id="cb100-90"><a href="#cb100-90" aria-hidden="true" tabindex="-1"></a>                <span class="at">gibbs.constant =</span> gibbs.constant))</span>
<span id="cb100-91"><a href="#cb100-91" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="running" class="level3">
<h3 class="anchored" data-anchor-id="running">2.2.2 Running</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>dp_res <span class="ot">&lt;-</span> <span class="fu">run.prism.Omega</span>(<span class="at">prism =</span> myPrism, <span class="at">Omega =</span> Omega, <span class="at">n.cores=</span><span class="dv">14</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dp_res, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"dp_res.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"dp_res.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="experiments" class="level3">
<h3 class="anchored" data-anchor-id="experiments">2.2.3 Experiments</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>sample_blk <span class="ot">&lt;-</span> <span class="st">"AN00000904_Br2720_Post_Bulk"</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>X_n <span class="ot">&lt;-</span> myPrism<span class="sc">@</span>mixture[sample_blk, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>gibbs.control <span class="ot">&lt;-</span> <span class="fu">valid.gibbs.control</span>(<span class="fu">list</span>(<span class="at">n.cores =</span> <span class="dv">14</span>, <span class="at">chain.length =</span> <span class="dv">1000</span>))</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>gibbs.idx <span class="ot">&lt;-</span> <span class="fu">get.gibbs.idx</span>(gibbs.control)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PRE-COMPUTATION (Run once per sample) ---</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(phi)</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>S_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(phi)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(phi)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>G_shared_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(G_names <span class="sc">%in%</span> <span class="fu">dimnames</span>(Omega)<span class="sc">$</span>Gene)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to pure numerical matrices (removes overhead of names/attributes)</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>phi_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(phi)</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>X_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X_n[G_names])</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>K_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(K_names)</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>S_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(S_names)</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>G_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(G_names)</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten Omega: [Sender] x [Receiver * Gene]</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a><span class="co"># This makes calculating Niche Pressure a single matrix multiplication</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>Omega_flat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Omega[K_names, S_names, G_names[G_shared_idx]], <span class="at">nrow =</span> S_dim, <span class="at">ncol =</span> S_dim <span class="sc">*</span> <span class="fu">length</span>(G_shared_idx))</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize variables</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>theta_n.i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>S_dim, S_dim)</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>Z_n.i <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> G_dim, <span class="at">ncol =</span> S_dim)</span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>Z_n.sum <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> G_dim, <span class="at">ncol =</span> S_dim)</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Z_n.sum) <span class="ot">&lt;-</span> G_names</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Z_n.sum) <span class="ot">&lt;-</span> S_names</span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>theta_n.sum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S_dim)</span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(theta_n.sum) <span class="ot">&lt;-</span> S_names</span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>theta_n2.sum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S_dim)</span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(theta_n2.sum) <span class="ot">&lt;-</span> S_names</span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>t.sum <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- START OF OPTIMIZED LOOP ---</span></span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(gibbs.idx)){</span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>  ti <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()[<span class="st">"elapsed"</span>]</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. CALCULATE NICHE PRESSURE (High Speed %*%)</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This calculates sum_k (theta_k * Omega_ksg) for all s and g in one shot</span></span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>  niche_pressure_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(theta_n.i <span class="sc">%*%</span> Omega_flat)</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>  niche_pressure_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(niche_pressure_vec, <span class="at">nrow =</span> S_dim, <span class="at">ncol =</span> <span class="fu">length</span>(G_shared_idx))</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>  niche_pressure_mat <span class="ot">&lt;-</span> (niche_pressure_mat) <span class="sc">/</span> <span class="fu">sd</span>(niche_pressure_mat)</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. VECTORIZED PROBABILITY MATRIX</span></span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We use the fact that (phi * theta) is a column-wise scaling</span></span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and exp(beta * niche) is element-wise</span></span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>  prob.mat <span class="ot">&lt;-</span> (phi_mat <span class="sc">*</span> theta_n.i)</span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>  prob.mat[,G_shared_idx] <span class="ot">&lt;-</span> prob.mat[,G_shared_idx] <span class="sc">*</span> <span class="fu">exp</span>(beta <span class="sc">*</span> niche_pressure_mat)</span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. THE SAMPLING LOOP (The bottleneck)</span></span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optimization: Use an integer loop and avoid any names</span></span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>G_dim) {</span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># size is the total bulk count for gene g</span></span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>    Z_n.i[g,] <span class="ot">&lt;-</span> <span class="fu">rmultinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> X_vec[g], <span class="at">prob =</span> prob.mat[, g])</span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. UPDATE THETA</span></span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a>  Z_nk.i <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Z_n.i)</span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a>  theta_n.i <span class="ot">&lt;-</span> <span class="fu">rdirichlet</span>(Z_nk.i <span class="sc">+</span> alpha)</span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. ACCUMULATE</span></span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%in%</span> gibbs.idx) {</span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a>    Z_n.sum <span class="ot">&lt;-</span> Z_n.sum <span class="sc">+</span> Z_n.i</span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a>    theta_n.sum <span class="ot">&lt;-</span> theta_n.sum <span class="sc">+</span> theta_n.i</span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a>    theta_n2.sum <span class="ot">&lt;-</span> theta_n2.sum <span class="sc">+</span> theta_n.i<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a>  tt <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()[<span class="st">"elapsed"</span>] <span class="sc">-</span> ti</span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a>  t.sum <span class="ot">&lt;-</span> t.sum <span class="sc">+</span> tt</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>((i <span class="sc">%%</span> <span class="dv">50</span>) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb104-72"><a href="#cb104-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">"</span>,i,<span class="st">"/"</span>,<span class="fu">max</span>(gibbs.idx))</span>
<span id="cb104-73"><a href="#cb104-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">": "</span>,t.sum<span class="sc">/</span><span class="dv">60</span>, <span class="st">" min elapsed. "</span>, (t.sum<span class="sc">/</span>i)<span class="sc">*</span>(<span class="fu">max</span>(gibbs.idx)<span class="sc">-</span>i)<span class="sc">/</span><span class="dv">60</span>, <span class="st">" min Remaining."</span>,  <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb104-74"><a href="#cb104-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb104-75"><a href="#cb104-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb104-76"><a href="#cb104-76" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>samples.size <span class="ot">&lt;-</span> <span class="fu">length</span>(gibbs.idx)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#gibbs.constant &lt;- multinom.coef + z.logtheta + theta.dirichlet.alpha</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>Z_n <span class="ot">&lt;-</span> Z_n.sum <span class="sc">/</span> samples.size</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>theta_n <span class="ot">&lt;-</span> theta_n.sum <span class="sc">/</span> samples.size</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>theta.cv_n <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(theta_n2.sum <span class="sc">/</span> samples.size <span class="sc">-</span> (theta_n<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">/</span> theta_n</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="co">#gibbs.constant &lt;- multinom.coef / samples.size</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
</section>
<section id="visualizing" class="level1">
<h1>Visualizing</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>sce_frac <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">colData</span>(sce)[sce<span class="sc">$</span>Sample <span class="sc">==</span> sample,]<span class="sc">$</span>cellType_hc)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">table</span>(<span class="fu">colData</span>(sce)[sce<span class="sc">$</span>Sample <span class="sc">==</span> sample,]<span class="sc">$</span>cellType_hc))</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sce_frac)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>frac_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> <span class="st">"sn-ref"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>bp_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta[sample_blk,])</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>bp_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_frac)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bp_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>bp_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>interac_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta[sample_blk,])</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>interac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(interac_frac)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(interac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>interac_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism ( = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">")"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>df_theta <span class="ot">&lt;-</span> <span class="fu">rbind</span>(frac_df, interac_df, bp_df)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>df_theta<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> state_to_type<span class="sc">$</span>cell_type[<span class="fu">match</span>(df_theta<span class="sc">$</span>cell_state, state_to_type<span class="sc">$</span>cell_state)]</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Plot using your colors</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_theta, <span class="fu">aes</span>(<span class="at">y =</span> Sample, <span class="at">x =</span> Proportion, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> type_colors) <span class="sc">+</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/frac_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>true_exp_mtx <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">length</span>(cell_states), </span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ncol =</span> <span class="fu">length</span>(<span class="fu">rownames</span>(sce)),</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">dimnames =</span> <span class="fu">list</span>(cell_states, <span class="fu">rownames</span>(sce)))</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> cell_states){</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  s_idx <span class="ot">&lt;-</span> <span class="fu">colnames</span>(sce)[sce<span class="sc">$</span>cellType_hc <span class="sc">==</span> s <span class="sc">&amp;</span> sce<span class="sc">$</span>Sample <span class="sc">==</span> sample]</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  true_rec_exp <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">as.matrix</span>(<span class="fu">counts</span>(sce[<span class="fu">colnames</span>(true_exp_mtx), s_idx])))</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  true_exp_mtx[s, ] <span class="ot">&lt;-</span> true_rec_exp</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: HDF5Array</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>true_exp_mtx <span class="ot">&lt;-</span> <span class="fu">t</span>(true_exp_mtx)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>bp_mtx <span class="ot">&lt;-</span> bp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>Z[sample_blk, , ]</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>dp_mtx <span class="ot">&lt;-</span> dp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>Z[sample_blk, , ]</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>true_cpm_mtx <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">t</span>(true_exp_mtx)<span class="sc">/</span><span class="fu">colSums</span>(true_exp_mtx)) <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>Z_cpm <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">t</span>(dp_mtx)<span class="sc">/</span><span class="fu">colSums</span>(dp_mtx)) <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>bp_cpm <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">t</span>(bp_mtx)<span class="sc">/</span><span class="fu">colSums</span>(bp_mtx)) <span class="sc">*</span> <span class="fl">1e6</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(dp_mtx)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>S_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(dp_mtx)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>G_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(G_names)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>S_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(S_names)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>Z_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene =</span> <span class="fu">rep</span>(G_names, <span class="at">times =</span> S_dim),</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell_state =</span> <span class="fu">rep</span>(S_names, <span class="at">each =</span> G_dim),</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">True =</span> <span class="fu">as.vector</span>(true_cpm_mtx[G_names, S_names]),</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">BayesPrism =</span> <span class="fu">as.vector</span>(bp_cpm[G_names, S_names]),</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">DynaPrism =</span> <span class="fu">as.vector</span>(Z_cpm[G_names, S_names])</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>Z_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> state_to_type<span class="sc">$</span>cell_type[<span class="fu">match</span>(Z_df<span class="sc">$</span>cell_state, state_to_type<span class="sc">$</span>cell_state)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> Z_df[Z_df<span class="sc">$</span>True <span class="sc">!=</span> <span class="dv">0</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>                <span class="co">#&amp; !Z_df$cell_type %in% c("Excit_11", "Excit_12")</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>                , ]</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>((plot_df<span class="sc">$</span>DynaPrism), plot_df<span class="sc">$</span>True, <span class="at">method=</span><span class="st">"spearman"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in cor.test.default((plot_df$DynaPrism), plot_df$True, method =
"spearman"): Cannot compute exact p-value with ties</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  (plot_df$DynaPrism) and plot_df$True
S = 2.2183e+15, p-value &lt; 2.2e-16
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.2946005 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>((plot_df<span class="sc">$</span>BayesPrism), plot_df<span class="sc">$</span>True, <span class="at">method=</span><span class="st">"spearman"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in cor.test.default((plot_df$BayesPrism), plot_df$True, method =
"spearman"): Cannot compute exact p-value with ties</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  (plot_df$BayesPrism) and plot_df$True
S = 2.7247e+15, p-value &lt; 2.2e-16
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.1335775 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dp_mae <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(plot_df<span class="sc">$</span>True<span class="sc">-</span>plot_df<span class="sc">$</span>DynaPrism), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>bp_mae <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(plot_df<span class="sc">$</span>True<span class="sc">-</span>plot_df<span class="sc">$</span>BayesPrism), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"DynaPrism MAE: "</span>, dp_mae), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>DynaPrism MAE: 113.252119001319 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"BayesPrism MAE: "</span>, bp_mae))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BayesPrism MAE: 152.68784301884</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stack_continuoush</span>(plot_df) <span class="sc">+</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> DynaPrism, <span class="at">y =</span> True, <span class="at">color =</span> cell_state)) <span class="sc">+</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>()) <span class="sc">+</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> state_colors) <span class="sc">+</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> BayesPrism, <span class="at">y =</span> True, <span class="at">color =</span> cell_state)) <span class="sc">+</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>()) <span class="sc">+</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> state_colors)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 25248 rows containing missing values or values outside the scale range
(`geom_point()`).
Removed 25248 rows containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/scatter_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cross-sample-comparisons" class="level1">
<h1>3. Cross-sample comparisons</h1>
<section id="state" class="level2">
<h2 class="anchored" data-anchor-id="state">3.1 State</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">unique</span>(sce<span class="sc">$</span>Sample), <span class="fu">unique</span>(blk<span class="sc">$</span>Sample))</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>blk_smp_ids <span class="ot">&lt;-</span> <span class="fu">lapply</span>(samples,<span class="cf">function</span>(sample)<span class="fu">unique</span>(<span class="fu">as.vector</span>(<span class="fu">colnames</span>(blk)[blk<span class="sc">$</span>Sample<span class="sc">==</span>sample])))</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(blk_smp_ids) <span class="ot">&lt;-</span> samples</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>blk_lib <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(blk)[,<span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>,<span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)])</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(blk_lib) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(blk_lib) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ID"</span>,<span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>true_s_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>  Source <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>  Sample <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>  cell_state <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>  Proportion <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>bp_s_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>  Source <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>  Sample <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>  ID <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>  cell_state <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>  Proportion <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>dp_s_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>  Source <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>  Sample <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>  ID <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>  cell_state <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>  Proportion <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sample <span class="cf">in</span> samples) {</span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a>  sc_frac <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">colData</span>(sce)[sce<span class="sc">$</span>Sample <span class="sc">==</span> sample,]<span class="sc">$</span>cellType_hc)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">table</span>(<span class="fu">colData</span>(sce)[sce<span class="sc">$</span>Sample <span class="sc">==</span> sample,]<span class="sc">$</span>cellType_hc))</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>  sc_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sc_frac)</span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(sc_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> sample</span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>library_prep <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>library_type <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>  true_s_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_s_df, sc_df)</span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (id <span class="cf">in</span> blk_smp_ids[[sample]]){</span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>    bp_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta[id,])</span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>    blk_bp_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_frac)</span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(blk_bp_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>    blk_bp_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> sample</span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>    blk_bp_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> id</span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>    blk_bp_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>    bp_s_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bp_s_df, blk_bp_df)</span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a>    dp_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta[id,])</span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>    blk_dp_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dp_frac)</span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(blk_dp_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>    blk_dp_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> sample</span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>    blk_dp_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> id</span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>    blk_dp_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>    dp_s_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dp_s_df, blk_dp_df)</span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a>true_s_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> state_to_type<span class="sc">$</span>cell_type[<span class="fu">match</span>(true_s_df<span class="sc">$</span>cell_state, state_to_type<span class="sc">$</span>cell_state)]</span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a>bp_s_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> state_to_type<span class="sc">$</span>cell_type[<span class="fu">match</span>(bp_s_df<span class="sc">$</span>cell_state, state_to_type<span class="sc">$</span>cell_state)]</span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a>bp_s_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(bp_s_df, blk_lib, <span class="at">by =</span> <span class="st">"ID"</span>)</span>
<span id="cb126-64"><a href="#cb126-64" aria-hidden="true" tabindex="-1"></a>dp_s_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> state_to_type<span class="sc">$</span>cell_type[<span class="fu">match</span>(dp_s_df<span class="sc">$</span>cell_state, state_to_type<span class="sc">$</span>cell_state)]</span>
<span id="cb126-65"><a href="#cb126-65" aria-hidden="true" tabindex="-1"></a>dp_s_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(dp_s_df, blk_lib, <span class="at">by =</span> <span class="st">"ID"</span>)</span>
<span id="cb126-66"><a href="#cb126-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-67"><a href="#cb126-67" aria-hidden="true" tabindex="-1"></a>true_s_df <span class="ot">&lt;-</span> true_s_df[<span class="fu">c</span>(<span class="st">"Source"</span>, <span class="st">"Sample"</span>, <span class="st">"ID"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>, <span class="st">"cell_type"</span>, <span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)]</span>
<span id="cb126-68"><a href="#cb126-68" aria-hidden="true" tabindex="-1"></a>bp_s_df <span class="ot">&lt;-</span> bp_s_df[<span class="fu">c</span>(<span class="st">"Source"</span>, <span class="st">"Sample"</span>, <span class="st">"ID"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>, <span class="st">"cell_type"</span>, <span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)]</span>
<span id="cb126-69"><a href="#cb126-69" aria-hidden="true" tabindex="-1"></a>dp_s_df <span class="ot">&lt;-</span> dp_s_df[<span class="fu">c</span>(<span class="st">"Source"</span>, <span class="st">"Sample"</span>, <span class="st">"ID"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>, <span class="st">"cell_type"</span>, <span class="st">"cell_state"</span>, <span class="st">"Proportion"</span>)]</span>
<span id="cb126-70"><a href="#cb126-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-71"><a href="#cb126-71" aria-hidden="true" tabindex="-1"></a>full_s_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_s_df, bp_s_df, dp_s_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>bp_plot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_s_df[true_s_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ], bp_s_df[bp_s_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ])</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>dp_plot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_s_df[true_s_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ], dp_s_df[dp_s_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ])</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggside</span>(bp_plot, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Proportion, <span class="at">fill =</span> cell_state)) <span class="sc">+</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> state_colors) <span class="sc">+</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"BayesPrism"</span>) <span class="sc">-</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anno_top</span>(<span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(bp_plot, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> <span class="dv">1</span>, <span class="at">fill =</span> library_type)) <span class="sc">+</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">-</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Estimated cell type fractions for "</span>, sample)) <span class="sc">+</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anno_top</span>() <span class="sc">+</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(bp_plot, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> <span class="dv">1</span>, <span class="at">fill =</span> library_prep)) <span class="sc">+</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">-</span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anno_bottom</span>() <span class="sc">+</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(dp_plot, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Proportion, <span class="at">fill =</span> cell_state)) <span class="sc">+</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> state_colors) <span class="sc">+</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"DynaPrism"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for y is already present.
Adding another scale for y, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="type" class="level2">
<h2 class="anchored" data-anchor-id="type">3.2 Type</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>true_t_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  Source <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  Sample <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>  Proportion <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>bp_t_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>  Source <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>  Sample <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  ID <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>  Proportion <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>dp_t_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>  Source <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>  Sample <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>  ID <span class="ot">&lt;-</span> <span class="cn">NULL</span>,</span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>  Proportion <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sample <span class="cf">in</span> samples) {</span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>  sc_frac <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">colData</span>(sce)[sce<span class="sc">$</span>Sample <span class="sc">==</span> sample,]<span class="sc">$</span>cellType_broad_hc)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">table</span>(<span class="fu">colData</span>(sce)[sce<span class="sc">$</span>Sample <span class="sc">==</span> sample,]<span class="sc">$</span>cellType_broad_hc))</span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>  sc_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sc_frac)</span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(sc_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_type"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> sample</span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>library_prep <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>  sc_df<span class="sc">$</span>library_type <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>  true_t_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_t_df, sc_df)</span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (id <span class="cf">in</span> blk_smp_ids[[sample]]){</span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bp_frac &lt;- as.table(bp_res@posterior.theta_f@theta[id,])</span></span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>    bp_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_res<span class="sc">@</span>posterior.initial.cellType<span class="sc">@</span>theta[id,])</span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>    blk_bp_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_frac)</span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(blk_bp_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_type"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>    blk_bp_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> sample</span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>    blk_bp_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> id</span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>    blk_bp_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a>    bp_t_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bp_t_df, blk_bp_df)</span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dp_frac &lt;- as.table(dp_res@posterior.theta_f@theta[id,])</span></span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>    dp_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_res<span class="sc">@</span>posterior.initial.cellType<span class="sc">@</span>theta[id,])</span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a>    blk_dp_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dp_frac)</span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(blk_dp_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_type"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>    blk_dp_df<span class="sc">$</span>Sample <span class="ot">&lt;-</span> sample</span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>    blk_dp_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> id</span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a>    blk_dp_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>    dp_t_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dp_t_df, blk_dp_df)</span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>bp_t_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(bp_t_df, blk_lib, <span class="at">by =</span> <span class="st">"ID"</span>)</span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>dp_t_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(dp_t_df, blk_lib, <span class="at">by =</span> <span class="st">"ID"</span>)</span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>true_t_df <span class="ot">&lt;-</span> true_t_df[<span class="fu">c</span>(<span class="st">"Source"</span>, <span class="st">"Sample"</span>, <span class="st">"ID"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>, <span class="st">"cell_type"</span>, <span class="st">"Proportion"</span>)]</span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>bp_t_df <span class="ot">&lt;-</span> bp_t_df[<span class="fu">c</span>(<span class="st">"Source"</span>, <span class="st">"Sample"</span>, <span class="st">"ID"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>, <span class="st">"cell_type"</span>, <span class="st">"Proportion"</span>)]</span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>dp_t_df <span class="ot">&lt;-</span> dp_t_df[<span class="fu">c</span>(<span class="st">"Source"</span>, <span class="st">"Sample"</span>, <span class="st">"ID"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>, <span class="st">"cell_type"</span>, <span class="st">"Proportion"</span>)]</span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a>full_t_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_t_df, bp_t_df, dp_t_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>bp_plot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_t_df[true_t_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ], bp_t_df[bp_t_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ])</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>dp_plot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(true_t_df[true_t_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ], dp_t_df[dp_t_df<span class="sc">$</span>Sample <span class="sc">==</span> sample, ])</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggside</span>(bp_plot, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Proportion, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> type_colors) <span class="sc">+</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"BayesPrism"</span>) <span class="sc">-</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anno_top</span>(<span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(bp_plot, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> <span class="dv">1</span>, <span class="at">fill =</span> library_type)) <span class="sc">+</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">-</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Estimated cell type fractions for "</span>, sample)) <span class="sc">+</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anno_top</span>() <span class="sc">+</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(bp_plot, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> <span class="dv">1</span>, <span class="at">fill =</span> library_prep)) <span class="sc">+</span></span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">-</span></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anno_bottom</span>() <span class="sc">+</span></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggalign</span>(dp_plot, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Proportion, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> type_colors) <span class="sc">+</span></span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"DynaPrism"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for y is already present.
Adding another scale for y, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked _by_ '.GlobalEnv':

    collapse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:Biobase':

    combine</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:GenomicRanges':

    intersect, setdiff, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:Seqinfo':

    intersect</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:IRanges':

    collapse, desc, intersect, setdiff, slice, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:S4Vectors':

    first, intersect, rename, setdiff, setequal, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:BiocGenerics':

    combine, intersect, setdiff, setequal, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:generics':

    explain</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:matrixStats':

    count</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyr' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tidyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:Matrix':

    expand, pack, unpack</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    expand</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>evaluate_deconvolution <span class="ot">&lt;-</span> <span class="cf">function</span>(pred_df, true_df) {</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Clean and Align Data</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We use inner_join to ensure only matching Sample/Cell_Type pairs are compared</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  aligned <span class="ot">&lt;-</span> pred_df <span class="sc">%&gt;%</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>      true_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sample, cell_type, <span class="at">Proportion_true =</span> Proportion),</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_type"</span>)</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Helper for MAECorr (as defined in your provided formula)</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>  calc_maecorr <span class="ot">&lt;-</span> <span class="cf">function</span>(sub_df) {</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pivot to Sample x CellType matrices</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>    E_mat <span class="ot">&lt;-</span> sub_df <span class="sc">%&gt;%</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Sample, cell_type, Proportion) <span class="sc">%&gt;%</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> cell_type, <span class="at">values_from =</span> Proportion) <span class="sc">%&gt;%</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>Sample) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>    G_mat <span class="ot">&lt;-</span> sub_df <span class="sc">%&gt;%</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Sample, cell_type, Proportion_true) <span class="sc">%&gt;%</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> cell_type, <span class="at">values_from =</span> Proportion_true) <span class="sc">%&gt;%</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>Sample) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pearson correlation between samples (t() used because cor() works on columns)</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>    P_E <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">t</span>(E_mat), <span class="at">method =</span> <span class="st">"pearson"</span>, <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>    P_G <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">t</span>(G_mat), <span class="at">method =</span> <span class="st">"pearson"</span>, <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(P_E <span class="sc">-</span> P_G), <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Calculate Sample-wise Spearman (Mean Rho per group)</span></span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a>  sample_rho <span class="ot">&lt;-</span> aligned <span class="sc">%&gt;%</span></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(library_prep, library_type, Sample) <span class="sc">%&gt;%</span></span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">rho =</span> <span class="fu">cor</span>(Proportion, Proportion_true, <span class="at">method =</span> <span class="st">"spearman"</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(library_prep, library_type) <span class="sc">%&gt;%</span></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">SCorr =</span> <span class="fu">mean</span>(rho, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Calculate Cell-type-wise Spearman (Mean Rho per group)</span></span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a>  cell_rho <span class="ot">&lt;-</span> aligned <span class="sc">%&gt;%</span></span>
<span id="cb150-40"><a href="#cb150-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(library_prep, library_type, cell_type) <span class="sc">%&gt;%</span></span>
<span id="cb150-41"><a href="#cb150-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">rho =</span> <span class="fu">cor</span>(Proportion, Proportion_true, <span class="at">method =</span> <span class="st">"spearman"</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb150-42"><a href="#cb150-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(library_prep, library_type) <span class="sc">%&gt;%</span></span>
<span id="cb150-43"><a href="#cb150-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">CCorr =</span> <span class="fu">mean</span>(rho, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb150-44"><a href="#cb150-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-45"><a href="#cb150-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Combine everything into Final Metrics</span></span>
<span id="cb150-46"><a href="#cb150-46" aria-hidden="true" tabindex="-1"></a>  final_metrics <span class="ot">&lt;-</span> aligned <span class="sc">%&gt;%</span></span>
<span id="cb150-47"><a href="#cb150-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(library_prep, library_type) <span class="sc">%&gt;%</span></span>
<span id="cb150-48"><a href="#cb150-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb150-49"><a href="#cb150-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(Proportion <span class="sc">-</span> Proportion_true), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb150-50"><a href="#cb150-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb150-51"><a href="#cb150-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb150-52"><a href="#cb150-52" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb150-53"><a href="#cb150-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(sample_rho, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb150-54"><a href="#cb150-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(cell_rho, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb150-55"><a href="#cb150-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate MAECorr for each group</span></span>
<span id="cb150-56"><a href="#cb150-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(library_prep, library_type) <span class="sc">%&gt;%</span></span>
<span id="cb150-57"><a href="#cb150-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_modify</span>(<span class="sc">~</span> {</span>
<span id="cb150-58"><a href="#cb150-58" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>MAECorr <span class="ot">&lt;-</span> <span class="fu">calc_maecorr</span>(<span class="fu">filter</span>(aligned, </span>
<span id="cb150-59"><a href="#cb150-59" aria-hidden="true" tabindex="-1"></a>                                        library_prep <span class="sc">==</span> .y<span class="sc">$</span>library_prep, </span>
<span id="cb150-60"><a href="#cb150-60" aria-hidden="true" tabindex="-1"></a>                                        library_type <span class="sc">==</span> .y<span class="sc">$</span>library_type))</span>
<span id="cb150-61"><a href="#cb150-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(.x)</span>
<span id="cb150-62"><a href="#cb150-62" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb150-63"><a href="#cb150-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb150-64"><a href="#cb150-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-65"><a href="#cb150-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final_metrics)</span>
<span id="cb150-66"><a href="#cb150-66" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate both</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>bp_results <span class="ot">&lt;-</span> <span class="fu">evaluate_deconvolution</span>(bp_t_df, true_t_df)</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>dp_results <span class="ot">&lt;-</span> <span class="fu">evaluate_deconvolution</span>(dp_t_df, true_t_df)</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare them side-by-side</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(bp_results, <span class="at">method =</span> <span class="st">"BayesPrism"</span>),</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(dp_results, <span class="at">method =</span> <span class="st">"DynaPrism"</span>)</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>comparison</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12  8
   library_prep library_type   MAE n_obs SCorr    CCorr MAECorr method    
   &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;     
 1 Bulk         RiboZeroGold 0.125   126 0.502  0.0972    0.377 BayesPrism
 2 Bulk         polyA        0.161   126 0.645 -0.0529    0.371 BayesPrism
 3 Cyto         RiboZeroGold 0.146   126 0.388  0.00929   0.372 BayesPrism
 4 Cyto         polyA        0.157   119 0.707  0.175     0.340 BayesPrism
 5 Nuc          RiboZeroGold 0.125   112 0.498  0.161     0.349 BayesPrism
 6 Nuc          polyA        0.163   119 0.641  0.222     0.390 BayesPrism
 7 Bulk         RiboZeroGold 0.110   126 0.559  0.124     0.369 DynaPrism 
 8 Bulk         polyA        0.147   126 0.535  0.0945    0.367 DynaPrism 
 9 Cyto         RiboZeroGold 0.127   126 0.466  0.0686    0.378 DynaPrism 
10 Cyto         polyA        0.154   119 0.698  0.131     0.337 DynaPrism 
11 Nuc          RiboZeroGold 0.110   112 0.530  0.164     0.352 DynaPrism 
12 Nuc          polyA        0.160   119 0.570  0.213     0.390 DynaPrism </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> comparison <span class="sc">%&gt;%</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(MAE, SCorr, CCorr, MAECorr),</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"metric"</span>,</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> library_prep, <span class="at">y =</span> value, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use dodge to put BayesPrism and DynaPrism side-by-side</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.8</span>), <span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Separate by library_type (polyA vs RiboZero) and Metric</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(metric <span class="sc">~</span> library_type, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Deconvolution Performance Comparison"</span>,</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparing BayesPrism vs DynaPrism across Library Preparations"</span>,</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Library Fraction"</span>,</span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Metric Value"</span>,</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Method"</span></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey90"</span>),</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">"grey80"</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>