<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DynaPrism</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="DynaPrism_files/libs/clipboard/clipboard.min.js"></script>
<script src="DynaPrism_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="DynaPrism_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="DynaPrism_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="DynaPrism_files/libs/quarto-html/popper.min.js"></script>
<script src="DynaPrism_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="DynaPrism_files/libs/quarto-html/anchor.min.js"></script>
<link href="DynaPrism_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="DynaPrism_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="DynaPrism_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="DynaPrism_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="DynaPrism_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DynaPrism</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="environment-set-up" class="level1">
<h1>0. Environment Set-Up</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(snowfall)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'snowfall' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: snow</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gplots)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'gplots' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
---------------------
gplots 3.3.0 loaded:
  * Use citation('gplots') for citation info.
  * Homepage: https://talgalili.github.io/gplots/
  * Report issues: https://github.com/talgalili/gplots/issues
  * Ask questions: https://stackoverflow.com/questions/tagged/gplots
  * Suppress this message with: suppressPackageStartupMessages(library(gplots))
---------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'gplots'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    lowess</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BiocParallel)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'BiocParallel' was built under R version 4.5.2</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scran)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scran' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: SingleCellExperiment</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'SingleCellExperiment' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: SummarizedExperiment</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'SummarizedExperiment' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MatrixGenerics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'MatrixGenerics' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: matrixStats</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MatrixGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:matrixStats':

    colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,
    colCounts, colCummaxs, colCummins, colCumprods, colCumsums,
    colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,
    colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,
    colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,
    colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,
    colWeightedMeans, colWeightedMedians, colWeightedSds,
    colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,
    rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,
    rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,
    rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,
    rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,
    rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,
    rowWeightedMads, rowWeightedMeans, rowWeightedMedians,
    rowWeightedSds, rowWeightedVars</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: GenomicRanges</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'GenomicRanges' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: stats4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: BiocGenerics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'BiocGenerics' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: generics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'generics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    as.difftime, as.factor, as.ordered, intersect, is.element, setdiff,
    setequal, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'BiocGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    IQR, mad, sd, var, xtabs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    anyDuplicated, aperm, append, as.data.frame, basename, cbind,
    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,
    get, grep, grepl, is.unsorted, lapply, Map, mapply, match, mget,
    order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,
    rbind, Reduce, rownames, sapply, saveRDS, table, tapply, unique,
    unsplit, which.max, which.min</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: S4Vectors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'S4Vectors' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'S4Vectors'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:gplots':

    space</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    findMatches</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    expand.grid, I, unname</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: IRanges</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'IRanges' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'IRanges'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:grDevices':

    windows</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Seqinfo</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Seqinfo' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Biobase</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Biobase' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Welcome to Bioconductor

    Vignettes contain introductory material; view with
    'browseVignettes()'. To cite Bioconductor, see
    'citation("Biobase")', and for packages 'citation("pkgname")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Biobase'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:MatrixGenerics':

    rowMedians</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:matrixStats':

    anyMissing, rowMedians</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: scuttle</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scuttle' was built under R version 4.5.2</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(utils)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(NMF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'NMF' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: registry</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'registry' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rngtools</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rngtools' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: cluster</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>NMF - BioConductor layer [OK] | Shared memory capabilities [NO: windows] | Cores 2/2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'NMF'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    nrun</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:generics':

    fit</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:BiocParallel':

    register</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Matrix' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    expand</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SingleCellExperiment)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggalign)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggalign' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>========================================
ggalign version 1.2.0

If you use it in published research, please cite: 
Peng, Y.; Jiang, S.; Song, Y.; et al. ggalign: Bridging the Grammar of Graphics and Biological Multilayered Complexity. Advanced Science. 2025. doi:10.1002/advs.202507799
========================================</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'ggalign'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:IRanges':

    active</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:S4Vectors':

    active</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(colorspace)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'colorspace' was built under R version 4.5.2</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'viridis' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: viridisLite</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyverse' was built under R version 4.5.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tibble' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyr' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'readr' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'purrr' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'forcats' was built under R version 4.5.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.6
✔ forcats   1.0.1     ✔ stringr   1.6.0
✔ lubridate 1.9.4     ✔ tibble    3.3.1
✔ purrr     1.2.1     ✔ tidyr     1.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ lubridate::%within%() masks IRanges::%within%()
✖ dplyr::collapse()     masks IRanges::collapse()
✖ dplyr::combine()      masks Biobase::combine(), BiocGenerics::combine()
✖ dplyr::count()        masks matrixStats::count()
✖ dplyr::desc()         masks IRanges::desc()
✖ tidyr::expand()       masks Matrix::expand(), S4Vectors::expand()
✖ dplyr::filter()       masks stats::filter()
✖ dplyr::first()        masks S4Vectors::first()
✖ dplyr::lag()          masks stats::lag()
✖ tidyr::pack()         masks Matrix::pack()
✖ ggplot2::Position()   masks BiocGenerics::Position(), base::Position()
✖ purrr::reduce()       masks GenomicRanges::reduce(), IRanges::reduce()
✖ dplyr::rename()       masks S4Vectors::rename()
✖ lubridate::second()   masks S4Vectors::second()
✖ lubridate::second&lt;-() masks S4Vectors::second&lt;-()
✖ dplyr::slice()        masks IRanges::slice()
✖ tidyr::unpack()       masks Matrix::unpack()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/classes.R"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/new_prism.R"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/run_prism.R"</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/run_gibbs.R"</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/JointPost_functions.R"</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/update_reference.R"</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../BayesPrism/R/optim_functions_MAP.R"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/Omega_tensor.R"</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/eval_functions.R"</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/plot_functions.R"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"../data/"</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.exists</span>(data_dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="loading-data" class="level1">
<h1>1. Loading Data</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>blk <span class="ot">&lt;-</span> DeconvoBuddies<span class="sc">::</span><span class="fu">fetch_deconvo_data</span>(<span class="st">"rse_gene"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"sce.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Getting lists of cell types and cell states.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>sce<span class="sc">$</span>cellType_hc <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(sce<span class="sc">$</span>cellType_hc)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>sce<span class="sc">$</span>cellType_broad_hc <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(sce<span class="sc">$</span>cellType_broad_hc)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>cell_types <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.vector</span>(sce<span class="sc">$</span>cellType_broad_hc))</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>cell_states <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.vector</span>(sce<span class="sc">$</span>cellType_hc))</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>type_to_state <span class="ot">&lt;-</span> <span class="fu">lapply</span>(cell_types,<span class="cf">function</span>(t)<span class="fu">unique</span>(<span class="fu">as.vector</span>(sce<span class="sc">$</span>cellType_hc[sce<span class="sc">$</span>cellType_broad_hc<span class="sc">==</span>t])))</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(type_to_state) <span class="ot">&lt;-</span> cell_types</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>state_to_type <span class="ot">&lt;-</span> <span class="fu">stack</span>(type_to_state)</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(state_to_type) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cell_state"</span>, <span class="st">"cell_type"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Color dictionaries for graphs</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>type_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Inhib =</span> <span class="st">"#369acc"</span>, </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Oligo =</span> <span class="st">"#f8e16f"</span>, </span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">OPC =</span> <span class="st">"#6c584c"</span>, </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Excit =</span> <span class="st">"#95cf92"</span>, </span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Astro =</span> <span class="st">"#9656a2"</span>, </span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">EndoMural =</span> <span class="st">"#f4895f"</span>, </span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Micro =</span> <span class="st">"#de324c"</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="co">#type_colors &lt;- setNames(brewer.pal(length(type_to_state), "Set3"), names(type_to_state))</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>state_colors <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">names</span>(type_to_state), <span class="cf">function</span>(ct) {</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  states <span class="ot">&lt;-</span> type_to_state[[ct]]</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(states)</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>  base <span class="ot">&lt;-</span> type_colors[ct]</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(<span class="fu">setNames</span>(base, states))</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>  pal_func <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lighten</span>(base, <span class="fl">0.3</span>), </span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>    base, </span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">darken</span>(base, <span class="fl">0.3</span>)</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">setNames</span>(<span class="fu">pal_func</span>(n), states))</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a><span class="co">#scales::show_col(type_colors)</span></span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a><span class="co">#scales::show_col(state_colors)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="omega-tensor" class="level1">
<h1>2. Omega tensor</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"Omega.rdata"</span>))</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"Weighted_Omega.rdata"</span>))</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>gene_pressure <span class="ot">&lt;-</span> <span class="fu">apply</span>(Omega, <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bayesprism" class="level1">
<h1>2. BayesPrism</h1>
<section id="new-prism" class="level2">
<h2 class="anchored" data-anchor-id="new-prism">2.1 New Prism</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>br_num <span class="ot">=</span> <span class="st">"Br2720"</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>position <span class="ot">=</span> <span class="st">"post"</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">=</span> <span class="fu">paste0</span>(br_num,<span class="st">"_"</span>,position)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(blk) <span class="ot">&lt;-</span> <span class="fu">rowData</span>(blk)<span class="sc">$</span>Symbol</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="co">#blk_sample = blk[intersect(rownames(sce), rownames(blk)),blk$Sample==sample]</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>myPrism <span class="ot">&lt;-</span> <span class="fu">new.prism</span>(</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference=</span><span class="fu">t</span>(<span class="fu">as.matrix</span>(<span class="fu">counts</span>(sce))), </span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture=</span><span class="fu">t</span>(<span class="fu">assay</span>(blk)),</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">input.type=</span><span class="st">"count.matrix"</span>, </span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell.type.labels =</span> sce<span class="sc">$</span>cellType_broad_hc, </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell.state.labels =</span> sce<span class="sc">$</span>cellType_hc,</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">key =</span> <span class="cn">NULL</span>,</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">outlier.cut=</span><span class="fl">0.01</span>,</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.fraction=</span><span class="fl">0.1</span>,</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(myPrism, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"myPrism.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"myPrism.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="run-bayesprism" class="level2">
<h2 class="anchored" data-anchor-id="run-bayesprism">2.2 Run BayesPrism</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>bp_res <span class="ot">&lt;-</span> <span class="fu">run.prism</span>(<span class="at">prism =</span> myPrism, <span class="at">n.cores=</span><span class="dv">14</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(bp_res, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"bp_res.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"bp_res.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="dynaprism-functions" class="level1">
<h1>3. DynaPrism Functions</h1>
<section id="classes" class="level2">
<h2 class="anchored" data-anchor-id="classes">3.1 Classes</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' An S4 class to represent the input, X, phi; alpha and controls of Gibbs sampling </span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot phi an array of dimension K*G to denote reference matrix</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot X a matrix of dimension N*G to denote bulk matrix</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot theta a matrix of dimension K*N to denote the cell type fraction in each bulk</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot alpha a numeric value to denote the symmetric Dirichlet prior, fixed to 1E-8 </span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot gibbs.control a list containing parameters of the Gibbs sampler</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="fu">setClass</span>(<span class="st">"gibbsSamplerOmega"</span>,</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">slots =</span> <span class="fu">c</span>(</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference =</span> <span class="st">"reference"</span>,</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">X =</span> <span class="st">"matrix"</span>,</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">Omega =</span> <span class="st">"array"</span>,</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">gibbs.control =</span> <span class="st">"list"</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">prototype =</span> <span class="fu">list</span>(</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">X =</span> <span class="fu">matrix</span>(),</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">gibbs.control =</span> <span class="fu">list</span>(<span class="at">chain.length =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>                                <span class="at">burn.in =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>                                <span class="at">thinning =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.cores =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>                                <span class="at">seed =</span> <span class="cn">NULL</span>,</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>                                <span class="at">alpha =</span> <span class="cn">NULL</span>, </span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>                                <span class="at">beta =</span> <span class="cn">NULL</span>)</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">validity =</span> <span class="cf">function</span>(object){</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>            errors <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is</span>(object<span class="sc">@</span>reference, <span class="st">"refPhi"</span>))</span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>                ref.gene <span class="ot">&lt;-</span> <span class="fu">colnames</span>(object<span class="sc">@</span>reference<span class="sc">@</span>phi)</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is</span>(object<span class="sc">@</span>reference, <span class="st">"refTumor"</span>))</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>                ref.gene <span class="ot">&lt;-</span> <span class="fu">colnames</span>(object<span class="sc">@</span>reference<span class="sc">@</span>psi_mal)</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(ref.gene, <span class="fu">colnames</span>(object<span class="sc">@</span>X))){</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>                msg <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Gene names do not match"</span>)</span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>                errors <span class="ot">&lt;-</span> <span class="fu">c</span>(errors, msg)</span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>                                                        </span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">length</span>(errors) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">TRUE</span> <span class="cf">else</span> errors</span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' An S4 class to represent the output of run.prism</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot input.initial.cellState an S4 object of class gibbsSampler </span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the input of initial Gibbs sampling over cell states </span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot posterior.initial.cellState an S4 object of class jointPost </span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the results of initial Gibbs sampling over cell states</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot posterior.initial.cellType an S4 object of class jointPost </span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the results over cell types merged from posterior.initial.cellState</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot reference.update an S4 object of class reference </span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'      to store the updated reference</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot posterior.theta_f matrix to represent the cell type fraction from the final Gibbs sampling</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @slot control_param a list to store all </span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="fu">setClass</span>(<span class="st">"BayesPrismOmega"</span>,</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">slots =</span> <span class="fu">c</span>(</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">prism =</span> <span class="st">"prism"</span>,</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">Omega =</span> <span class="st">"array"</span>,</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellState =</span> <span class="st">"jointPost"</span>,</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellType =</span> <span class="st">"jointPost"</span>,</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference.update =</span> <span class="st">"reference"</span>,</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.theta_f =</span> <span class="st">"theta_f"</span>,</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">control_param =</span> <span class="st">"list"</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">prototype =</span> <span class="fu">list</span>(</span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">prism =</span> <span class="fu">new</span>(<span class="st">"prism"</span>),</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellState =</span> <span class="fu">new</span>(<span class="st">"jointPost"</span>),</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.initial.cellType =</span> <span class="fu">new</span>(<span class="st">"jointPost"</span>),</span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">reference.update =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">posterior.theta_f =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">control_param =</span> <span class="fu">list</span>(<span class="at">gibbs.control =</span> <span class="fu">list</span>(<span class="at">chain.length =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">burn.in =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">thinning =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n.cores =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">seed =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">alpha=</span><span class="cn">NULL</span>,</span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">beta =</span> <span class="cn">NULL</span>),</span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">opt.control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="cn">NULL</span>, </span>
<span id="cb107-39"><a href="#cb107-39" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">maxit =</span> <span class="cn">NULL</span>,</span>
<span id="cb107-40"><a href="#cb107-40" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">optimizer =</span> <span class="cn">NA_character_</span>, </span>
<span id="cb107-41"><a href="#cb107-41" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">n.cores =</span> <span class="cn">NULL</span>),</span>
<span id="cb107-42"><a href="#cb107-42" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">map =</span> <span class="fu">list</span>(),</span>
<span id="cb107-43"><a href="#cb107-43" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">key =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb107-44"><a href="#cb107-44" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">update.gibbs =</span> <span class="fu">logical</span>())</span>
<span id="cb107-45"><a href="#cb107-45" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb107-46"><a href="#cb107-46" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="run-prism-functions" class="level2">
<h2 class="anchored" data-anchor-id="run-prism-functions">3.2 Run Prism Functions</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to validate gibbs.control</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param control a named list of parameters required to control optimization  </span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>valid.gibbs.control.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(control){</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">chain.length=</span><span class="dv">1000</span>, <span class="at">burn.in=</span><span class="dv">500</span>, <span class="at">thinning=</span><span class="dv">2</span>, <span class="at">n.cores=</span><span class="dv">1</span>, <span class="at">seed=</span><span class="dv">123</span>, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">beta =</span> <span class="fl">0.4</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    namc <span class="ot">&lt;-</span> <span class="fu">names</span>(control)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(namc <span class="sc">%in%</span> <span class="fu">names</span>(ctrl)))</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"unknown names in gibbs.control: "</span>, namc[<span class="sc">!</span>(namc <span class="sc">%in%</span> <span class="fu">names</span>(ctrl))])</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    ctrl[namc] <span class="ot">&lt;-</span> control</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(ctrl<span class="sc">$</span>alpha <span class="sc">&lt;</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"alpha needs to be positive"</span>)</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ctrl<span class="sc">$</span>beta <span class="sc">&lt;</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"beta needs to be positive"</span>)</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(ctrl)</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' main function to run deconvolution using BayesPrism</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n.cores number of cores to use. Default =1.</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'      If needs to set different number of cores for Gibbs sampling and optimization,</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'      supply n.cores in gibbs.control and/or opt.control</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param update.gibbs a logical variable to denote whether run final Gibbs sampling to update theta</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbs.control a list containing parameters of the Gibbs sampler</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'      chain.length: length of MCMC chain. Default=1000;</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'      burn.in: length of burn in period. Default=500;</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'      thinning: retain every # of MCMC samples after the burn in period to reduce auto-correlation. Default=2;</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'      n.cores: number of cores to use. Default uses n.cores in the main argument.</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'      seed: seed number to use for repoducibility. Default = 123. set to NULL if use pseudo random.</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'      alpha: a numeric vector to represent the parameter of dirichlet distribution. Default=1. (1E-8 may yield theta=0 due to underflow. causes issue when psuedo.min=0) </span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'      beta: a numeric vector to represent the strength of the interatcion term</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param opt.control a list containing parameters for the optimization step:</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'      maxit: maximum number of cycles to interate. Default=100000</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a><span class="co">#'      sigma: hyper-parameter of the prior if optimizer="MAP". Default=2.</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'      optimizer a character string to denote which algorithm to use</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'          "MAP": the one used by the BayesPrism paper, with cell type-specific gamma under a log-normal prior </span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'          "MLE": the new algorithm that models a single gamma across cell types. Useful when some cell types are low in Z_k, e.g. spatial data</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="co">#'          default to "MAP"</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>run.prism.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(prism,</span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>                            Omega,</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>                            <span class="at">n.cores=</span><span class="dv">1</span>,</span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>                            <span class="at">update.gibbs=</span><span class="cn">TRUE</span>,</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gibbs.control=</span><span class="fu">list</span>(),</span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">opt.control=</span><span class="fu">list</span>()</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>                            ){</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span> <span class="st">"n.cores"</span> <span class="sc">%in%</span> <span class="fu">names</span>(gibbs.control)) gibbs.control<span class="sc">$</span>n.cores <span class="ot">&lt;-</span> n.cores</span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span> <span class="st">"n.cores"</span> <span class="sc">%in%</span> <span class="fu">names</span>(opt.control)) opt.control<span class="sc">$</span>n.cores <span class="ot">&lt;-</span> n.cores</span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(update.gibbs) <span class="sc">&amp;</span> <span class="fu">length</span>(update.gibbs)<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(n.cores) <span class="sc">&amp;</span> <span class="fu">length</span>(n.cores)<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a>    opt.control <span class="ot">&lt;-</span> <span class="fu">valid.opt.control</span>(opt.control)</span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> <span class="fu">valid.gibbs.control.Omega</span>(gibbs.control)</span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(prism<span class="sc">@</span>phi_cellState<span class="sc">@</span>pseudo.min<span class="sc">==</span><span class="dv">0</span>) </span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a>        gibbs.control<span class="sc">$</span>alpha <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, gibbs.control<span class="sc">$</span>alpha)</span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#write mixture to disk and load each X_n to the corresponding node to save memory</span></span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a>    tmp.dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>(<span class="at">check=</span><span class="cn">TRUE</span>)</span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(prism<span class="sc">@</span>mixture)) {</span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a>        X_n <span class="ot">&lt;-</span> prism<span class="sc">@</span>mixture[n,]</span>
<span id="cb109-45"><a href="#cb109-45" aria-hidden="true" tabindex="-1"></a>        file.name <span class="ot">&lt;-</span> <span class="fu">paste</span>(tmp.dir, <span class="st">"/mixture_"</span>,n,<span class="st">".rdata"</span>,<span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb109-46"><a href="#cb109-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">save</span>(X_n, <span class="at">file=</span> file.name)</span>
<span id="cb109-47"><a href="#cb109-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb109-48"><a href="#cb109-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb109-49"><a href="#cb109-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sampling cell states (cs)</span></span>
<span id="cb109-50"><a href="#cb109-50" aria-hidden="true" tabindex="-1"></a>    gibbsSampler.ini.cs <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"gibbsSamplerOmega"</span>,</span>
<span id="cb109-51"><a href="#cb109-51" aria-hidden="true" tabindex="-1"></a>                                <span class="at">reference =</span> prism<span class="sc">@</span>phi_cellState,</span>
<span id="cb109-52"><a href="#cb109-52" aria-hidden="true" tabindex="-1"></a>                                <span class="at">X =</span> prism<span class="sc">@</span>mixture,</span>
<span id="cb109-53"><a href="#cb109-53" aria-hidden="true" tabindex="-1"></a>                                <span class="at">Omega =</span> Omega,</span>
<span id="cb109-54"><a href="#cb109-54" aria-hidden="true" tabindex="-1"></a>                                <span class="at">gibbs.control =</span> gibbs.control)</span>
<span id="cb109-55"><a href="#cb109-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-56"><a href="#cb109-56" aria-hidden="true" tabindex="-1"></a>    jointPost.ini.cs <span class="ot">&lt;-</span> <span class="fu">run.gibbs.Omega</span>(gibbsSampler.ini.cs, Omega,</span>
<span id="cb109-57"><a href="#cb109-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">final=</span><span class="cn">FALSE</span>)</span>
<span id="cb109-58"><a href="#cb109-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-59"><a href="#cb109-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#merge over cell states to get cell type (ct) info</span></span>
<span id="cb109-60"><a href="#cb109-60" aria-hidden="true" tabindex="-1"></a>    jointPost.ini.ct <span class="ot">&lt;-</span> <span class="fu">mergeK</span>(<span class="at">jointPost.obj =</span> jointPost.ini.cs, </span>
<span id="cb109-61"><a href="#cb109-61" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">map =</span> prism<span class="sc">@</span>map)</span>
<span id="cb109-62"><a href="#cb109-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-63"><a href="#cb109-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>update.gibbs) <span class="co">#only do initial Gibbs sampling</span></span>
<span id="cb109-64"><a href="#cb109-64" aria-hidden="true" tabindex="-1"></a>        bp.obj <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"BayesPrismOmega"</span>,</span>
<span id="cb109-65"><a href="#cb109-65" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prism =</span> prism,</span>
<span id="cb109-66"><a href="#cb109-66" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Omega =</span> Omega,</span>
<span id="cb109-67"><a href="#cb109-67" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellState =</span> jointPost.ini.cs,</span>
<span id="cb109-68"><a href="#cb109-68" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellType =</span> jointPost.ini.ct,</span>
<span id="cb109-69"><a href="#cb109-69" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_param =</span> <span class="fu">list</span>(<span class="at">gibbs.control =</span> gibbs.control, </span>
<span id="cb109-70"><a href="#cb109-70" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">opt.control =</span> opt.control,</span>
<span id="cb109-71"><a href="#cb109-71" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">update.gibbs =</span> update.gibbs)</span>
<span id="cb109-72"><a href="#cb109-72" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb109-73"><a href="#cb109-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb109-74"><a href="#cb109-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">#contruct the new gibbsSampler object with updated reference</span></span>
<span id="cb109-75"><a href="#cb109-75" aria-hidden="true" tabindex="-1"></a>        psi <span class="ot">&lt;-</span> <span class="fu">updateReference</span> (<span class="at">Z =</span> jointPost.ini.ct<span class="sc">@</span>Z,</span>
<span id="cb109-76"><a href="#cb109-76" aria-hidden="true" tabindex="-1"></a>                                <span class="at">phi_prime =</span> prism<span class="sc">@</span>phi_cellType,</span>
<span id="cb109-77"><a href="#cb109-77" aria-hidden="true" tabindex="-1"></a>                                <span class="at">map =</span> prism<span class="sc">@</span>map,</span>
<span id="cb109-78"><a href="#cb109-78" aria-hidden="true" tabindex="-1"></a>                                <span class="at">key =</span> prism<span class="sc">@</span>key,</span>
<span id="cb109-79"><a href="#cb109-79" aria-hidden="true" tabindex="-1"></a>                                <span class="at">opt.control =</span> opt.control)</span>
<span id="cb109-80"><a href="#cb109-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-81"><a href="#cb109-81" aria-hidden="true" tabindex="-1"></a>        gibbsSampler.update <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"gibbsSampler"</span>,</span>
<span id="cb109-82"><a href="#cb109-82" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">reference =</span> psi,</span>
<span id="cb109-83"><a href="#cb109-83" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X =</span> prism<span class="sc">@</span>mixture,</span>
<span id="cb109-84"><a href="#cb109-84" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">gibbs.control =</span> gibbs.control)</span>
<span id="cb109-85"><a href="#cb109-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-86"><a href="#cb109-86" aria-hidden="true" tabindex="-1"></a>        theta_f <span class="ot">&lt;-</span> <span class="fu">run.gibbs</span>(gibbsSampler.update, </span>
<span id="cb109-87"><a href="#cb109-87" aria-hidden="true" tabindex="-1"></a>                             <span class="at">final=</span><span class="cn">TRUE</span>)</span>
<span id="cb109-88"><a href="#cb109-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-89"><a href="#cb109-89" aria-hidden="true" tabindex="-1"></a>        bp.obj <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">"BayesPrismOmega"</span>,</span>
<span id="cb109-90"><a href="#cb109-90" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prism =</span> prism,</span>
<span id="cb109-91"><a href="#cb109-91" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Omega =</span> Omega,</span>
<span id="cb109-92"><a href="#cb109-92" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellState =</span> jointPost.ini.cs,</span>
<span id="cb109-93"><a href="#cb109-93" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.initial.cellType =</span> jointPost.ini.ct,</span>
<span id="cb109-94"><a href="#cb109-94" aria-hidden="true" tabindex="-1"></a>                      <span class="at">reference.update =</span> psi,</span>
<span id="cb109-95"><a href="#cb109-95" aria-hidden="true" tabindex="-1"></a>                      <span class="at">posterior.theta_f =</span> theta_f,</span>
<span id="cb109-96"><a href="#cb109-96" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_param =</span> <span class="fu">list</span>(<span class="at">gibbs.control =</span> gibbs.control, </span>
<span id="cb109-97"><a href="#cb109-97" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">opt.control =</span> opt.control,</span>
<span id="cb109-98"><a href="#cb109-98" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">update.gibbs =</span> update.gibbs)</span>
<span id="cb109-99"><a href="#cb109-99" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb109-100"><a href="#cb109-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb109-101"><a href="#cb109-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-102"><a href="#cb109-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlink</span>(tmp.dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb109-103"><a href="#cb109-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-104"><a href="#cb109-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(bp.obj)      </span>
<span id="cb109-105"><a href="#cb109-105" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="run-gibbs-functions" class="level2">
<h2 class="anchored" data-anchor-id="run-gibbs-functions">3.3 Run Gibbs functions</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#‘ function used to estimate run time of Gibbs sampling (print to console)</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj a gibbsSampler object</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param final a logical variable denote whether report only updated theta_f (final =TRUE)</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param chain.length length of MCMC chain used to simulate. Default=50.</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>estimate.gibbs.time.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>                                final, </span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">chain.length=</span><span class="dv">50</span>){</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    ref <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>reference</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>X</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>gibbs.control</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>final){</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#initial Gibbs</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample.Z.theta_n.Omega</span> (<span class="at">X_n =</span> X[<span class="dv">1</span>,], </span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">phi =</span> ref<span class="sc">@</span>phi, </span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">alpha =</span> gibbs.control<span class="sc">$</span>alpha,</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Omega =</span> gibbsSampler.obj<span class="sc">@</span>Omega,</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">beta =</span> gibbs.control<span class="sc">$</span>beta,</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">gibbs.idx =</span> <span class="fu">get.gibbs.idx</span>(</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">list</span>(<span class="at">chain.length =</span> chain.length, </span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">burn.in =</span> chain.length<span class="sc">*</span>gibbs.control<span class="sc">$</span>burn.in<span class="sc">/</span>gibbs.control<span class="sc">$</span>chain.length,</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">thinning =</span> gibbs.control<span class="sc">$</span>thinning)</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>                                  )</span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>                           )</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">#updated Gibbs</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is</span>(ref,<span class="st">"refPhi"</span>)){</span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.theta_n</span> (<span class="at">X_n =</span> X[<span class="dv">1</span>,], </span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>                            <span class="at">phi =</span> ref<span class="sc">@</span>phi, </span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> gibbs.control<span class="sc">$</span>alpha,</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gibbs.idx =</span> <span class="fu">get.gibbs.idx</span>(</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">list</span>(<span class="at">chain.length =</span> chain.length, </span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">burn.in =</span> chain.length<span class="sc">*</span>gibbs.control<span class="sc">$</span>burn.in<span class="sc">/</span>gibbs.control<span class="sc">$</span>chain.length,</span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">thinning =</span> gibbs.control<span class="sc">$</span>thinning)</span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>                                 )</span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a>                                )</span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is</span>(ref,<span class="st">"refTumor"</span>)){</span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a>            phi_1 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(ref<span class="sc">@</span>psi_mal[<span class="dv">1</span>,], ref<span class="sc">@</span>psi_env)</span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a>            nonzero.idx <span class="ot">&lt;-</span> <span class="fu">apply</span>(phi_1,<span class="dv">2</span>,max)<span class="sc">&gt;</span><span class="dv">0</span></span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.theta_n</span> (<span class="at">X_n =</span> X[<span class="dv">1</span>,nonzero.idx, <span class="at">drop=</span>F], </span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a>                            <span class="at">phi =</span> phi_1[, nonzero.idx, <span class="at">drop=</span>F], </span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a>                            <span class="at">alpha =</span> gibbs.control<span class="sc">$</span>alpha,</span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gibbs.idx =</span> <span class="fu">get.gibbs.idx</span>(</span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">list</span>(<span class="at">chain.length =</span> chain.length, </span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">burn.in =</span> chain.length<span class="sc">*</span>gibbs.control<span class="sc">$</span>burn.in<span class="sc">/</span>gibbs.control<span class="sc">$</span>chain.length,</span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">thinning =</span> gibbs.control<span class="sc">$</span>thinning)</span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a>                                )</span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a>                                )   </span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a>        }   </span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a>    total.time <span class="ot">&lt;-</span> <span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a>    total.time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(total.time[<span class="st">"elapsed"</span>])</span>
<span id="cb110-59"><a href="#cb110-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-60"><a href="#cb110-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># seems to underestimate when transferring data comsumes large amount of time (spatial data)</span></span>
<span id="cb110-61"><a href="#cb110-61" aria-hidden="true" tabindex="-1"></a>    estimated.time <span class="ot">&lt;-</span> gibbs.control <span class="sc">$</span>chain.length <span class="sc">/</span> chain.length <span class="sc">*</span> total.time <span class="sc">*</span> <span class="fu">ceiling</span>(<span class="fu">nrow</span>(X) <span class="sc">/</span> gibbs.control<span class="sc">$</span>n.cores) <span class="sc">*</span><span class="dv">2</span>         </span>
<span id="cb110-62"><a href="#cb110-62" aria-hidden="true" tabindex="-1"></a>    current.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb110-63"><a href="#cb110-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-64"><a href="#cb110-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Current time: "</span>, <span class="fu">as.character</span>(current.time), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb110-65"><a href="#cb110-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Estimated time to complete: "</span>, <span class="fu">my_seconds_to_period</span>(estimated.time), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb110-66"><a href="#cb110-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Estimated finishing time: "</span>, <span class="fu">as.character</span>(current.time <span class="sc">+</span> estimated.time), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb110-67"><a href="#cb110-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-68"><a href="#cb110-68" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run Gibbs sampling </span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj, a gibbsSampler object</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param final a logical variable denote whether report only updated theta_f (final=TRUE)</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param if.estimate a logical variable denote whether estimate the run time. Default=TRUE</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import snowfall</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a gibbsSampler object with Z and theta entries, if final=FALSE,  or theta_f matrix if final=TRUE</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>run.gibbs.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj, </span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>                            Omega,</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>                            final,</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">if.estimate=</span><span class="cn">TRUE</span>,</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">compute.elbo=</span><span class="cn">FALSE</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>                            ){</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(final) <span class="fu">cat</span>(<span class="st">"Run Gibbs sampling using updated reference ... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="fu">cat</span>(<span class="st">"Run Gibbs sampling... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(if.estimate)</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">estimate.gibbs.time.Omega</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj, </span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">final =</span> final)</span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is</span>(gibbsSampler.obj<span class="sc">@</span>reference,<span class="st">"refPhi"</span>)) {</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span>final) <span class="fu">return</span>(<span class="fu">run.gibbs.refPhi.ini.Omega</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj, </span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">Omega =</span> Omega,</span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">compute.elbo =</span> compute.elbo))</span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="fu">return</span>(<span class="fu">run.gibbs.refPhi.final.Omega</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj, </span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">Omega =</span> Omega,</span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">compute.elbo =</span> compute.elbo))</span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is</span>(gibbsSampler.obj<span class="sc">@</span>reference,<span class="st">"refTumor"</span>)) {</span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">run.gibbs.refTumor</span>(<span class="at">gibbsSampler.obj =</span> gibbsSampler.obj)) </span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run initial Gibbs sampling if reference is of the class refPhi</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj, a gibbsSampler object</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import snowfall</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a jointPost object with Z and theta entries </span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>run.gibbs.refPhi.ini.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj,</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>                                       Omega,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>                                       compute.elbo){</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>reference<span class="sc">@</span>phi</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>X</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>gibbs.control</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>alpha</span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>beta</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    gibbs.idx <span class="ot">&lt;-</span> <span class="fu">get.gibbs.idx</span>(gibbs.control)</span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>    seed <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>seed</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>    <span class="do">##### LOOK INTO THESE</span></span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sample.Z.theta_n.Omega &lt;- DynaPrism:::sample.Z.theta_n.Omega</span></span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rdirichlet &lt;- BayesPrism:::rdirichlet</span></span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Start run... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(gibbs.control<span class="sc">$</span>n.cores<span class="sc">&gt;</span><span class="dv">1</span>){    </span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">#parallel using snowfall    </span></span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfInit</span>(<span class="at">parallel =</span> <span class="cn">TRUE</span>, <span class="at">cpus =</span> gibbs.control<span class="sc">$</span>n.cores, <span class="at">type =</span> <span class="st">"SOCK"</span> )</span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a>        cpu.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">#load nth mixture from disk</span></span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>            file.name.X_n <span class="ot">&lt;-</span> <span class="fu">paste</span>(tmp.dir, <span class="st">"/mixture_"</span>,n,<span class="st">".rdata"</span>,<span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">load</span>(file.name.X_n)</span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-35"><a href="#cb112-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.Z.theta_n.Omega</span> (<span class="at">X_n =</span> X_n, </span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a>                              <span class="at">phi =</span> phi, </span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a>                              <span class="at">alpha =</span> alpha, </span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Omega =</span> Omega,</span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>                              <span class="at">beta =</span> beta,</span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a>                              <span class="at">gibbs.idx =</span> gibbs.idx, </span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a>                              <span class="at">compute.elbo =</span> compute.elbo)      </span>
<span id="cb112-42"><a href="#cb112-42" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb112-43"><a href="#cb112-43" aria-hidden="true" tabindex="-1"></a>        tmp.dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>(<span class="at">check=</span><span class="cn">TRUE</span>)</span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfExport</span>(<span class="st">"phi"</span>, <span class="st">"alpha"</span>, <span class="st">"Omega"</span>, <span class="st">"beta"</span>, <span class="st">"gibbs.idx"</span>, <span class="st">"seed"</span>, </span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"compute.elbo"</span>, <span class="st">"sample.Z.theta_n.Omega"</span>,<span class="st">"rdirichlet"</span>,<span class="st">"tmp.dir"</span>)</span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">environment</span>(cpu.fun) <span class="ot">&lt;-</span> <span class="fu">globalenv</span>()</span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a>        gibbs.list <span class="ot">&lt;-</span> <span class="fu">sfLapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), cpu.fun)</span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfStop</span>()</span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">#single thread</span></span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>        cpu.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(n,<span class="st">" "</span>)</span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sample.Z.theta_n.Omega</span> (<span class="at">X_n =</span> X[n,], </span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">phi =</span> phi,</span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">alpha =</span> alpha, </span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Omega =</span> Omega,</span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">alpha =</span> alpha,</span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">gibbs.idx =</span> gibbs.idx,</span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">compute.elbo =</span> compute.elbo)</span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a>        gibbs.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), cpu.fun)</span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-65"><a href="#cb112-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-66"><a href="#cb112-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-67"><a href="#cb112-67" aria-hidden="true" tabindex="-1"></a>    jointPost <span class="ot">&lt;-</span> <span class="fu">newJointPost</span>(<span class="at">bulkID =</span> <span class="fu">rownames</span>(X),</span>
<span id="cb112-68"><a href="#cb112-68" aria-hidden="true" tabindex="-1"></a>                              <span class="at">geneID =</span> <span class="fu">colnames</span>(X), </span>
<span id="cb112-69"><a href="#cb112-69" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cellType =</span> <span class="fu">rownames</span>(phi),</span>
<span id="cb112-70"><a href="#cb112-70" aria-hidden="true" tabindex="-1"></a>                              <span class="at">gibbs.list =</span> gibbs.list )</span>
<span id="cb112-71"><a href="#cb112-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(jointPost)</span>
<span id="cb112-72"><a href="#cb112-72" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run final sampling if reference is of the class refPhi</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbsSampler.obj, a gibbsSampler object</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import snowfall</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a theta_f matrix </span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>run.gibbs.refPhi.final.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(gibbsSampler.obj,</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>                                   Omega,</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>                                   compute.elbo){</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>reference<span class="sc">@</span>phi</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>X</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    gibbs.control <span class="ot">&lt;-</span> gibbsSampler.obj<span class="sc">@</span>gibbs.control</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    alpha <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>alpha</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>beta</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>    gibbs.idx <span class="ot">&lt;-</span> <span class="fu">get.gibbs.idx</span>(gibbs.control)</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>    seed <span class="ot">&lt;-</span> gibbs.control<span class="sc">$</span>seed</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>    <span class="do">##### LOOK INTO THESE</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sample.theta_n.Omega &lt;- DynaPrism:::sample.theta_n.Omega</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rdirichlet &lt;- BayesPrism:::rdirichlet</span></span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Start run... </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(gibbs.control<span class="sc">$</span>n.cores<span class="sc">&gt;</span><span class="dv">1</span>){    </span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">#parallel using snowfall    </span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfInit</span>(<span class="at">parallel =</span> <span class="cn">TRUE</span>, <span class="at">cpus =</span> gibbs.control<span class="sc">$</span>n.cores, <span class="at">type =</span> <span class="st">"SOCK"</span> )</span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>        cpu.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">#load nth mixture from disk</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>            file.name.X_n <span class="ot">&lt;-</span> <span class="fu">paste</span>(tmp.dir, <span class="st">"/mixture_"</span>,n,<span class="st">".rdata"</span>,<span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">load</span>(file.name.X_n)</span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.theta_n.Omega</span> (<span class="at">X_n =</span> X_n, </span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>                                <span class="at">phi =</span> phi, </span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>                                <span class="at">alpha =</span> alpha, </span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Omega =</span> Omega,</span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>                              <span class="at">beta =</span> beta,</span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>                                <span class="at">gibbs.idx =</span> gibbs.idx)      </span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>        tmp.dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>(<span class="at">check=</span><span class="cn">TRUE</span>)</span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfExport</span>(<span class="st">"phi"</span>, <span class="st">"alpha"</span>, <span class="st">"gibbs.idx"</span>, <span class="st">"seed"</span>, </span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"compute.elbo"</span>, <span class="st">"sample.theta_n"</span>,<span class="st">"rdirichlet"</span>,<span class="st">"tmp.dir"</span>)</span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">environment</span>(cpu.fun) <span class="ot">&lt;-</span> <span class="fu">globalenv</span>()</span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>        gibbs.list <span class="ot">&lt;-</span> <span class="fu">sfLapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), cpu.fun)</span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sfStop</span>() </span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">#single thread</span></span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>        cpu.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(n,<span class="st">" "</span>)</span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample.theta_n.Omega</span> (<span class="at">X_n =</span> X[n,], <span class="at">phi =</span> phi, <span class="at">alpha =</span> alpha,</span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Omega =</span> Omega,</span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>                              <span class="at">beta =</span> beta, <span class="at">gibbs.idx =</span> gibbs.idx)</span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>        gibbs.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>( <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), cpu.fun)</span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>    thetaPost <span class="ot">&lt;-</span> <span class="fu">newThetaPost</span> (<span class="at">bulkID =</span> <span class="fu">rownames</span>(X),</span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">cellType =</span> <span class="fu">rownames</span>(phi),</span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">gibbs.list =</span> gibbs.list)</span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(thetaPost)</span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sampler-functions" class="level2">
<h2 class="anchored" data-anchor-id="sampler-functions">3.4 Sampler functions</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' function to run Gibbs sampling for Z and theta on each bulk</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_n a numeric vector of reads count of the nth bulk sample</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param phi an array of dimension K*G to denote reference matrix</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alpha a numeric value to denote the symmetric Dirichlet prior </span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gibbs.idx a numeric vector to denote the index of samples to be retained from MCMC chain</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param compute.elbo a logical variable to denote if compute ELBO. Default=FALSE.</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' return a list containing the posterior mean of Z_n and theta_n</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>sample.Z.theta_n.Omega <span class="ot">&lt;-</span> <span class="cf">function</span>(X_n, </span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>                                 phi,</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>                                alpha,</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>                                Omega, </span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>                                beta,</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>                                gibbs.idx,</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>                                <span class="at">compute.elbo=</span><span class="cn">FALSE</span>){</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Setting up Omega implementatiom</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>    K_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(phi) <span class="co"># # of Sender States</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>    S_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(phi) <span class="co"># # of Receiver States</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>    G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(phi) <span class="co"># # of Genes</span></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>    G_shared_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(phi) <span class="sc">%in%</span> <span class="fu">dimnames</span>(Omega)<span class="sc">$</span>Gene)</span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>    G_shared_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(phi)[G_shared_idx]</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>    K_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(K_names)</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>    S_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(S_names)</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>    G_dim <span class="ot">&lt;-</span> <span class="fu">length</span>(G_names)</span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>    theta_n.i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>S_dim, S_dim)</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>    Z_n.i <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>,<span class="fu">c</span>(G_dim,S_dim))</span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>    Z_n.sum <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>,<span class="fu">c</span>(G_dim,S_dim))</span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>    theta_n.sum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S_dim)</span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>    theta_n2.sum <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S_dim)</span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#variable for computing ELBO</span></span>
<span id="cb114-35"><a href="#cb114-35" aria-hidden="true" tabindex="-1"></a>    multinom.coef <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb114-36"><a href="#cb114-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-37"><a href="#cb114-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb114-38"><a href="#cb114-38" aria-hidden="true" tabindex="-1"></a>    phi_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(phi)</span>
<span id="cb114-39"><a href="#cb114-39" aria-hidden="true" tabindex="-1"></a>    X_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X_n[G_names])</span>
<span id="cb114-40"><a href="#cb114-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-41"><a href="#cb114-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Making Omega flat</span></span>
<span id="cb114-42"><a href="#cb114-42" aria-hidden="true" tabindex="-1"></a>    Omega_flat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Omega[K_names, S_names, G_shared_names], <span class="at">nrow =</span> S_dim, <span class="at">ncol =</span> S_dim <span class="sc">*</span> <span class="fu">length</span>(G_shared_names))</span>
<span id="cb114-43"><a href="#cb114-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-44"><a href="#cb114-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(gibbs.idx)){</span>
<span id="cb114-45"><a href="#cb114-45" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb114-46"><a href="#cb114-46" aria-hidden="true" tabindex="-1"></a>      niche_pressure_vec <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(theta_n.i <span class="sc">%*%</span> Omega_flat)</span>
<span id="cb114-47"><a href="#cb114-47" aria-hidden="true" tabindex="-1"></a>      niche_pressure_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(niche_pressure_vec, <span class="at">nrow =</span> S_dim, <span class="at">ncol =</span> <span class="fu">length</span>(G_shared_idx))</span>
<span id="cb114-48"><a href="#cb114-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb114-49"><a href="#cb114-49" aria-hidden="true" tabindex="-1"></a>      sd_p <span class="ot">&lt;-</span> <span class="fu">sd</span>(niche_pressure_mat)</span>
<span id="cb114-50"><a href="#cb114-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(sd_p) <span class="sc">&amp;&amp;</span> sd_p <span class="sc">&gt;</span> <span class="dv">0</span>) niche_pressure_mat <span class="ot">&lt;-</span> niche_pressure_mat <span class="sc">/</span> sd_p</span>
<span id="cb114-51"><a href="#cb114-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-52"><a href="#cb114-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">#sample Z for patient n</span></span>
<span id="cb114-53"><a href="#cb114-53" aria-hidden="true" tabindex="-1"></a>      prob.mat <span class="ot">&lt;-</span> (phi_mat <span class="sc">*</span> theta_n.i)</span>
<span id="cb114-54"><a href="#cb114-54" aria-hidden="true" tabindex="-1"></a>      prob.mat[,G_shared_idx] <span class="ot">&lt;-</span> prob.mat[,G_shared_idx] <span class="sc">*</span> <span class="fu">exp</span>(beta <span class="sc">*</span> niche_pressure_mat)</span>
<span id="cb114-55"><a href="#cb114-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-56"><a href="#cb114-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>G_dim) {</span>
<span id="cb114-57"><a href="#cb114-57" aria-hidden="true" tabindex="-1"></a>        Z_n.i[g,] <span class="ot">&lt;-</span> <span class="fu">rmultinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> X_vec[g], <span class="at">prob =</span> prob.mat[, g])</span>
<span id="cb114-58"><a href="#cb114-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb114-59"><a href="#cb114-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample theta for patient n</span></span>
<span id="cb114-60"><a href="#cb114-60" aria-hidden="true" tabindex="-1"></a>        Z_nk.i <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Z_n.i) <span class="co">#total count for each cell type</span></span>
<span id="cb114-61"><a href="#cb114-61" aria-hidden="true" tabindex="-1"></a>        theta_n.i <span class="ot">&lt;-</span> <span class="fu">rdirichlet</span>(<span class="at">alpha =</span> Z_nk.i <span class="sc">+</span> alpha)</span>
<span id="cb114-62"><a href="#cb114-62" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb114-63"><a href="#cb114-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i <span class="sc">%in%</span> gibbs.idx) {</span>
<span id="cb114-64"><a href="#cb114-64" aria-hidden="true" tabindex="-1"></a>            <span class="co">#collect sample and compute posterior sum</span></span>
<span id="cb114-65"><a href="#cb114-65" aria-hidden="true" tabindex="-1"></a>            Z_n.sum <span class="ot">&lt;-</span> Z_n.sum <span class="sc">+</span> Z_n.i</span>
<span id="cb114-66"><a href="#cb114-66" aria-hidden="true" tabindex="-1"></a>            theta_n.sum <span class="ot">&lt;-</span> theta_n.sum <span class="sc">+</span> theta_n.i</span>
<span id="cb114-67"><a href="#cb114-67" aria-hidden="true" tabindex="-1"></a>            theta_n2.sum <span class="ot">&lt;-</span> theta_n2.sum <span class="sc">+</span> theta_n.i<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb114-68"><a href="#cb114-68" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-69"><a href="#cb114-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(compute.elbo){</span>
<span id="cb114-70"><a href="#cb114-70" aria-hidden="true" tabindex="-1"></a>                <span class="co"># multinom.coef.i &lt;- sum((alpha-1) * log(theta_n.i), na.rm=TRUE) + </span></span>
<span id="cb114-71"><a href="#cb114-71" aria-hidden="true" tabindex="-1"></a>                                   <span class="co"># sum(Z_nk.i * log(theta_n.i), na.rm=TRUE) - </span></span>
<span id="cb114-72"><a href="#cb114-72" aria-hidden="true" tabindex="-1"></a>                                   <span class="co"># sum(lfactorial(Z_nk.i)) - sum(lfactorial(Z_n.i))</span></span>
<span id="cb114-73"><a href="#cb114-73" aria-hidden="true" tabindex="-1"></a>                multinom.coef.i <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">lfactorial</span>(Z_nk.i)) <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">lfactorial</span>(Z_n.i))</span>
<span id="cb114-74"><a href="#cb114-74" aria-hidden="true" tabindex="-1"></a>                multinom.coef <span class="ot">&lt;-</span> multinom.coef <span class="sc">+</span> multinom.coef.i</span>
<span id="cb114-75"><a href="#cb114-75" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb114-76"><a href="#cb114-76" aria-hidden="true" tabindex="-1"></a>            }   </span>
<span id="cb114-77"><a href="#cb114-77" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb114-78"><a href="#cb114-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-79"><a href="#cb114-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>((i <span class="sc">%%</span> <span class="dv">50</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">gc</span>()</span>
<span id="cb114-80"><a href="#cb114-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb114-81"><a href="#cb114-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-82"><a href="#cb114-82" aria-hidden="true" tabindex="-1"></a>    samples.size <span class="ot">&lt;-</span> <span class="fu">length</span>(gibbs.idx)</span>
<span id="cb114-83"><a href="#cb114-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">#gibbs.constant &lt;- multinom.coef + z.logtheta + theta.dirichlet.alpha</span></span>
<span id="cb114-84"><a href="#cb114-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-85"><a href="#cb114-85" aria-hidden="true" tabindex="-1"></a>    Z_n <span class="ot">&lt;-</span> Z_n.sum <span class="sc">/</span> samples.size</span>
<span id="cb114-86"><a href="#cb114-86" aria-hidden="true" tabindex="-1"></a>    theta_n <span class="ot">&lt;-</span> theta_n.sum <span class="sc">/</span> samples.size</span>
<span id="cb114-87"><a href="#cb114-87" aria-hidden="true" tabindex="-1"></a>    theta.cv_n <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(theta_n2.sum <span class="sc">/</span> samples.size <span class="sc">-</span> (theta_n<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">/</span> theta_n</span>
<span id="cb114-88"><a href="#cb114-88" aria-hidden="true" tabindex="-1"></a>    gibbs.constant <span class="ot">&lt;-</span> multinom.coef <span class="sc">/</span> samples.size</span>
<span id="cb114-89"><a href="#cb114-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-90"><a href="#cb114-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Z_n =</span> Z_n, </span>
<span id="cb114-91"><a href="#cb114-91" aria-hidden="true" tabindex="-1"></a>                <span class="at">theta_n =</span> theta_n,</span>
<span id="cb114-92"><a href="#cb114-92" aria-hidden="true" tabindex="-1"></a>                <span class="at">theta.cv_n =</span> theta.cv_n,</span>
<span id="cb114-93"><a href="#cb114-93" aria-hidden="true" tabindex="-1"></a>                <span class="at">gibbs.constant =</span> gibbs.constant))</span>
<span id="cb114-94"><a href="#cb114-94" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="running-dynaprism" class="level2">
<h2 class="anchored" data-anchor-id="running-dynaprism">3.5 Running DynaPrism</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>dp_res <span class="ot">&lt;-</span> <span class="fu">run.prism.Omega</span>(<span class="at">prism =</span> myPrism, <span class="at">Omega =</span> Omega, <span class="at">n.cores=</span><span class="dv">14</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dp_res, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"dp_res.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"dp_res.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="bulk-library-evaluations" class="level1">
<h1>4. Bulk Library Evaluations</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>lib_prep <span class="ot">&lt;-</span> <span class="st">"Bulk"</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>lib_type <span class="ot">&lt;-</span> <span class="st">"polyA"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="fraction-estimations" class="level2">
<h2 class="anchored" data-anchor-id="fraction-estimations">4.1 Fraction estimations</h2>
<section id="cell-state" class="level3">
<h3 class="anchored" data-anchor-id="cell-state">4.1.1 Cell-State</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>blk_n_meta <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(blk)[,<span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"Sample"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)])</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>cells_per_state <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">colData</span>(sce)<span class="sc">$</span>Sample, <span class="fu">colData</span>(sce)<span class="sc">$</span>cellType_hc)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>true_s_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>((cells_per_state<span class="sc">/</span><span class="fu">rowSums</span>(cells_per_state))[,cell_states])</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>bp_s_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta)[<span class="fu">rownames</span>(blk_n_meta),cell_states]</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>dp_s_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta)[<span class="fu">rownames</span>(blk_n_meta),cell_states]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>dp_s_lib <span class="ot">&lt;-</span> (dp_s_frac[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type,])</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dp_s_lib) <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">rownames</span>(dp_s_lib),<span class="st">"Sample"</span>]</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>bp_s_lib <span class="ot">&lt;-</span> (bp_s_frac[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type,])</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(bp_s_lib) <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">rownames</span>(bp_s_lib),<span class="st">"Sample"</span>]</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>lib_s_frac_dp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(dp_s_lib, true_s_frac)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>lib_s_frac_bp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(bp_s_lib, true_s_frac)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>true_s_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(true_s_frac)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(true_s_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_state"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>true_s_frac_df<span class="sc">$</span>SAMPLE_ID <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>true_s_frac_df<span class="sc">$</span>library_prep <span class="ot">&lt;-</span> <span class="st">"Nuc"</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>true_s_frac_df<span class="sc">$</span>library_type <span class="ot">&lt;-</span> <span class="st">"polyA"</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>true_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(true_s_frac_df<span class="sc">$</span>cell_state))</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>true_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">factor</span>(true_s_frac_df<span class="sc">$</span>cell_state, </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(true_s_frac_df<span class="sc">$</span>cell_state)))</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>bp_s_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_s_frac)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bp_s_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"cell_state"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>bp_s_frac_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(bp_s_frac_df, </span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>                    blk_n_meta[, <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"Sample"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)], </span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"SAMPLE_ID"</span>, </span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>bp_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(bp_s_frac_df<span class="sc">$</span>cell_state))</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>bp_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">factor</span>(bp_s_frac_df<span class="sc">$</span>cell_state,</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bp_s_frac_df<span class="sc">$</span>cell_state)))</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>dp_s_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dp_s_frac)</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dp_s_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"cell_state"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>dp_s_frac_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(dp_s_frac_df, </span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>                    blk_n_meta[, <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"Sample"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)], </span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"SAMPLE_ID"</span>, </span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>dp_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(dp_s_frac_df<span class="sc">$</span>cell_state))</span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>dp_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">factor</span>(dp_s_frac_df<span class="sc">$</span>cell_state,</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(dp_s_frac_df<span class="sc">$</span>cell_state)))</span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>true_s_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>bp_s_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>dp_s_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">")"</span>)</span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a>combined_s_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bp_s_frac_df, dp_s_frac_df, true_s_frac_df)</span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.character</span>(<span class="fu">unique</span>(combined_s_df<span class="sc">$</span>Sample)))[<span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)]</span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>combined_s_df <span class="ot">&lt;-</span> combined_s_df[combined_s_df<span class="sc">$</span>Sample <span class="sc">%in%</span> samples, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_s_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> Fraction, <span class="at">x =</span> library_prep, <span class="at">fill =</span> cell_state)) <span class="sc">+</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> state_colors) <span class="sc">+</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(Sample <span class="sc">~</span> Source <span class="sc">+</span> library_type, <span class="at">scales =</span> <span class="st">"free_x"</span>, <span class="at">space =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="co"># Use a cleaner base theme</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove y-axis text and ticks</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate the Sample labels (strips) on the right to be horizontal</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>),</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate x-axis labels if they start to overlap</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: adjust the spacing between facets</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"lines"</span>)</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cell-type" class="level3">
<h3 class="anchored" data-anchor-id="cell-type">4.1.2 Cell-Type</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>cells_per_type <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">colData</span>(sce)<span class="sc">$</span>Sample, <span class="fu">colData</span>(sce)<span class="sc">$</span>cellType_broad_hc)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>true_t_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>((cells_per_type<span class="sc">/</span><span class="fu">rowSums</span>(cells_per_type))[, cell_types])</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="co">#bp_t_frac &lt;- as.table(bp_res@posterior.initial.cellType@theta)[rownames(blk_n_meta), cell_types]</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>bp_t_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_res<span class="sc">@</span>posterior.theta_f<span class="sc">@</span>theta)[<span class="fu">rownames</span>(blk_n_meta), cell_types]</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co">#dp_t_frac &lt;- as.table(dp_res@posterior.initial.cellType@theta)[rownames(blk_n_meta), cell_types]</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>dp_t_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_res<span class="sc">@</span>posterior.theta_f<span class="sc">@</span>theta)[<span class="fu">rownames</span>(blk_n_meta), cell_types]</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>dp_t_lib <span class="ot">&lt;-</span> dp_t_frac[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type,]</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dp_t_lib) <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">rownames</span>(dp_t_lib),<span class="st">"Sample"</span>]</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>bp_t_lib <span class="ot">&lt;-</span> bp_t_frac[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type,]</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(bp_t_lib) <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">rownames</span>(bp_t_lib),<span class="st">"Sample"</span>]</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>lib_t_frac_dp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(dp_t_lib, true_t_frac)</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>lib_t_frac_bp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(bp_t_lib, true_t_frac)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>true_t_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(true_t_frac)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(true_t_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_type"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>true_t_frac_df<span class="sc">$</span>SAMPLE_ID <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>true_t_frac_df<span class="sc">$</span>library_prep <span class="ot">&lt;-</span> <span class="st">"Nuc"</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>true_t_frac_df<span class="sc">$</span>library_type <span class="ot">&lt;-</span> <span class="st">"polyA"</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>true_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(true_t_frac_df<span class="sc">$</span>cell_type))</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>true_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(true_t_frac_df<span class="sc">$</span>cell_type, </span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(true_t_frac_df<span class="sc">$</span>cell_type)))</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>bp_t_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_t_frac)</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bp_t_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"cell_type"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>bp_t_frac_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(bp_t_frac_df, </span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>                    blk_n_meta[, <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"Sample"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)], </span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"SAMPLE_ID"</span>, </span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>bp_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(bp_t_frac_df<span class="sc">$</span>cell_type))</span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>bp_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(bp_t_frac_df<span class="sc">$</span>cell_type,</span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bp_t_frac_df<span class="sc">$</span>cell_type)))</span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>dp_t_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dp_t_frac)</span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dp_t_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"cell_type"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>dp_t_frac_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(dp_t_frac_df, </span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>                    blk_n_meta[, <span class="fu">c</span>(<span class="st">"SAMPLE_ID"</span>, <span class="st">"Sample"</span>, <span class="st">"library_prep"</span>, <span class="st">"library_type"</span>)], </span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"SAMPLE_ID"</span>, </span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>dp_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(dp_t_frac_df<span class="sc">$</span>cell_type))</span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>dp_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(dp_t_frac_df<span class="sc">$</span>cell_type,</span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(dp_t_frac_df<span class="sc">$</span>cell_type)))</span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>true_t_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"snRNA-seq"</span></span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>bp_t_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>dp_t_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">")"</span>)</span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>combined_t_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bp_t_frac_df, dp_t_frac_df, true_t_frac_df)</span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.character</span>(<span class="fu">unique</span>(combined_t_df<span class="sc">$</span>Sample)))[<span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)]</span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>combined_t_df <span class="ot">&lt;-</span> combined_t_df[combined_t_df<span class="sc">$</span>Sample <span class="sc">%in%</span> samples, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_t_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> Fraction, <span class="at">x =</span> library_prep, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> type_colors) <span class="sc">+</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(Sample <span class="sc">~</span> Source <span class="sc">+</span> library_type, <span class="at">scales =</span> <span class="st">"free_x"</span>, <span class="at">space =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="co"># Use a cleaner base theme</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove y-axis text and ticks</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate the Sample labels (strips) on the right to be horizontal</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>),</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate x-axis labels if they start to overlap</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: adjust the spacing between facets</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"lines"</span>)</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="ctse-estimations" class="level2">
<h2 class="anchored" data-anchor-id="ctse-estimations">4.2 CTSE estimations</h2>
<section id="cell-state-1" class="level3">
<h3 class="anchored" data-anchor-id="cell-state-1">4.2.1 Cell-state</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/eval_functions.R"</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>true_s_exp <span class="ot">&lt;-</span> <span class="fu">sc_exp_tensor</span>(<span class="fu">assay</span>(sce, <span class="st">"counts"</span>), <span class="fu">colData</span>(sce)<span class="sc">$</span>Sample, <span class="fu">colData</span>(sce)<span class="sc">$</span>cellType_hc, <span class="at">fun =</span> <span class="st">"sum"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: HDF5Array</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>counts_per_state <span class="ot">&lt;-</span> <span class="fu">apply</span>(true_s_exp, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>true_s_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>((counts_per_state<span class="sc">/</span><span class="fu">rowSums</span>(counts_per_state))[, cell_states])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>bp_s_exp <span class="ot">&lt;-</span> bp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>Z</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>dp_s_exp <span class="ot">&lt;-</span> dp_res<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>Z</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>bp_param <span class="ot">&lt;-</span> <span class="fu">SnowParam</span>(<span class="at">workers =</span> <span class="dv">14</span>, <span class="at">type =</span> <span class="st">"SOCK"</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>state_markers <span class="ot">&lt;-</span> <span class="fu">findMarkers</span>(</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    sce, </span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> sce<span class="sc">$</span>cellType_hc, </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">block =</span> sce<span class="sc">$</span>Sample,</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">test.type =</span> <span class="st">"t"</span>,</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"up"</span>,</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">BPPARAM =</span> bp_param</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(state_markers, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"state_markers.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"state_markers.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>state_marker_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(state_markers, <span class="cf">function</span>(x) {</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter by FDR and logFC thresholds</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> x[x<span class="sc">$</span>FDR <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">&amp;</span> x<span class="sc">$</span>summary.logFC <span class="sc">&gt;</span> <span class="dv">1</span>, ]</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by the most specific (lowest FDR or highest logFC)</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sorting by logFC is usually better for 'identity' markers</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> sub[<span class="fu">order</span>(sub<span class="sc">$</span>summary.logFC, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take the top 50 (or fewer if less pass the filter)</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>    top_genes <span class="ot">&lt;-</span> <span class="fu">head</span>(<span class="fu">rownames</span>(sub), <span class="dv">50</span>)</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(top_genes)</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>lib_prep <span class="ot">&lt;-</span> <span class="st">"Bulk"</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>lib_type <span class="ot">&lt;-</span> <span class="st">"polyA"</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>bp_s_lib <span class="ot">&lt;-</span> bp_s_exp[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, , ]</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(bp_s_lib)[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">dimnames</span>(bp_s_lib)[[<span class="dv">1</span>]],<span class="st">"Sample"</span>]</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>dp_s_lib <span class="ot">&lt;-</span> dp_s_exp[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, , ]</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(dp_s_lib)[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">dimnames</span>(dp_s_lib)[[<span class="dv">1</span>]],<span class="st">"Sample"</span>]</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/eval_functions.R"</span>)</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the evaluation</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>lib_s_CTSE_dp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(dp_s_lib, true_s_exp, <span class="at">markers_list =</span> state_marker_list)</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>lib_s_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(bp_s_lib, true_s_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_s_CTSE_dp, lib_s_CTSE_bp, </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over BayesPrism"</span>),</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> state_colors, </span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.
ℹ Please use the `linewidth` argument instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ExpSpe</span>(lib_s_CTSE_dp, lib_s_CTSE_bp, gene_pressure, </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"State-Level Expression Specificity"</span>,</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") on "</span>, lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="plain-bulk" class="level4">
<h4 class="anchored" data-anchor-id="plain-bulk">4.2.1.1 Plain Bulk</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(myPrism<span class="sc">@</span>mixture)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>X_cpm <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X, <span class="dv">1</span>, <span class="fu">rowSums</span>(X), <span class="st">"/"</span>) <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>N_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(X)</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> cell_states</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>blk_s_exp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, </span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(N_names), <span class="fu">length</span>(G_names), <span class="fu">length</span>(K_names)),</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dimnames =</span> <span class="fu">list</span>(N_names, G_names, K_names))</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> K_names) {</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  blk_s_exp[,,k] <span class="ot">&lt;-</span> X</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>blk_s_lib <span class="ot">&lt;-</span> blk_s_exp[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, , ]</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(blk_s_lib)[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">dimnames</span>(blk_s_lib)[[<span class="dv">1</span>]],<span class="st">"Sample"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>lib_s_CTSE_blk <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(blk_s_lib, true_s_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_s_CTSE_dp, lib_s_CTSE_blk, </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over Plain Bulk"</span>),</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> state_colors, </span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_s_CTSE_bp, lib_s_CTSE_blk, </span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> state_colors, </span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"BayesPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="cell-type-1" class="level3">
<h3 class="anchored" data-anchor-id="cell-type-1">4.2.2 Cell-type</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>true_t_exp <span class="ot">&lt;-</span> <span class="fu">sc_exp_tensor</span>(<span class="fu">assay</span>(sce, <span class="st">"counts"</span>), <span class="fu">colData</span>(sce)<span class="sc">$</span>Sample, <span class="fu">colData</span>(sce)<span class="sc">$</span>cellType_broad_hc, <span class="at">fun =</span> <span class="st">"sum"</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>counts_per_type <span class="ot">&lt;-</span> <span class="fu">apply</span>(true_t_exp, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>true_t_frac <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>((counts_per_type<span class="sc">/</span><span class="fu">rowSums</span>(counts_per_type))[,cell_types])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>bp_t_exp <span class="ot">&lt;-</span> bp_res<span class="sc">@</span>posterior.initial.cellType<span class="sc">@</span>Z</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>dp_t_exp <span class="ot">&lt;-</span> dp_res<span class="sc">@</span>posterior.initial.cellType<span class="sc">@</span>Z</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>bp_param <span class="ot">&lt;-</span> <span class="fu">SnowParam</span>(<span class="at">workers =</span> <span class="dv">14</span>, <span class="at">type =</span> <span class="st">"SOCK"</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>type_markers <span class="ot">&lt;-</span> <span class="fu">findMarkers</span>(</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    sce, </span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> sce<span class="sc">$</span>cellType_broad_hc, </span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">block =</span> sce<span class="sc">$</span>Sample,</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">test.type =</span> <span class="st">"t"</span>,</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"up"</span>,</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">BPPARAM =</span> bp_param</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(type_markers, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"type_markers.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"type_markers.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>type_marker_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(type_markers, <span class="cf">function</span>(x) {</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter by FDR and logFC thresholds</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> x[x<span class="sc">$</span>FDR <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">&amp;</span> x<span class="sc">$</span>summary.logFC <span class="sc">&gt;</span> <span class="dv">1</span>, ]</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by the most specific (lowest FDR or highest logFC)</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sorting by logFC is usually better for 'identity' markers</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> sub[<span class="fu">order</span>(sub<span class="sc">$</span>summary.logFC, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take the top 50 (or fewer if less pass the filter)</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    top_genes <span class="ot">&lt;-</span> <span class="fu">head</span>(<span class="fu">rownames</span>(sub), <span class="dv">50</span>)</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(top_genes)</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co">#lib_prep &lt;- "Nuc"</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="co">#lib_type &lt;- "RiboZeroGold"</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>bp_t_lib <span class="ot">&lt;-</span> bp_t_exp[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, , ]</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(bp_t_lib)[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">dimnames</span>(bp_t_lib)[[<span class="dv">1</span>]],<span class="st">"Sample"</span>]</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>dp_t_lib <span class="ot">&lt;-</span> dp_t_exp[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, , ]</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(dp_t_lib)[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">dimnames</span>(dp_t_lib)[[<span class="dv">1</span>]],<span class="st">"Sample"</span>]</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the evaluation</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/eval_functions.R"</span>)</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>lib_t_CTSE_dp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(dp_t_lib, true_t_exp, <span class="at">markers_list =</span> type_marker_list)</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>lib_t_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(bp_t_lib, true_t_exp, <span class="at">markers_list =</span> type_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_t_CTSE_dp, lib_t_CTSE_bp, </span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain"</span>),</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ExpSpe</span>(lib_t_CTSE_dp, lib_t_CTSE_bp, gene_pressure, </span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Type-Level Expression Specificity"</span>,</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") on "</span>, lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="plain-bulk-1" class="level4">
<h4 class="anchored" data-anchor-id="plain-bulk-1">4.2.2.1 Plain Bulk</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(myPrism<span class="sc">@</span>mixture)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>X_cpm <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X, <span class="dv">1</span>, <span class="fu">rowSums</span>(X), <span class="st">"/"</span>) <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>N_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(X)</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> cell_types</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>blk_t_exp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, </span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(N_names), <span class="fu">length</span>(G_names), <span class="fu">length</span>(K_names)),</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dimnames =</span> <span class="fu">list</span>(N_names, G_names, K_names))</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> K_names) {</span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>  blk_t_exp[,,k] <span class="ot">&lt;-</span> X</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>blk_t_lib <span class="ot">&lt;-</span> blk_t_exp[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, , ]</span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(blk_t_lib)[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> blk_n_meta[<span class="fu">rownames</span>(blk_n_meta) <span class="sc">%in%</span> <span class="fu">dimnames</span>(blk_t_lib)[[<span class="dv">1</span>]],<span class="st">"Sample"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>lib_t_CTSE_blk <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(blk_t_lib, true_t_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_t_CTSE_dp, lib_t_CTSE_blk, </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over Plain Bulk"</span>),</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_t_CTSE_bp, lib_t_CTSE_blk, </span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"BayesPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fraction-regressed-bulk" class="level4">
<h4 class="anchored" data-anchor-id="fraction-regressed-bulk">4.2.2.2 Fraction-Regressed Bulk</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>X_lib <span class="ot">&lt;-</span> X[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, ]</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(X_lib) <span class="ot">&lt;-</span> blk_n_meta[blk_n_meta<span class="sc">$</span>library_prep <span class="sc">==</span> lib_prep <span class="sc">&amp;</span> blk_n_meta<span class="sc">$</span>library_type <span class="sc">==</span> lib_type, <span class="st">"Sample"</span>]</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>common_n <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">rownames</span>(X_lib), <span class="fu">rownames</span>(true_t_frac))</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>X_lib <span class="ot">&lt;-</span> X_lib[common_n, ]</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>theta_t <span class="ot">&lt;-</span> true_t_frac[common_n, ]</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>beta_hat_t <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(theta_t) <span class="sc">%*%</span> theta_t) <span class="sc">%*%</span> <span class="fu">t</span>(theta_t) <span class="sc">%*%</span> X_lib</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>X_hat_t <span class="ot">&lt;-</span> theta_t <span class="sc">%*%</span> beta_hat_t</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>mu_g <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(X_lib)</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate X_regress: X_observed - X_predicted + mu_g</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>X_regress_t <span class="ot">&lt;-</span> X_lib <span class="sc">-</span> X_hat_t</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>X_regress_t <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X_regress_t, <span class="dv">2</span>, mu_g, <span class="st">"+"</span>)</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>X_regress_t[X_regress_t <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(theta_t)</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X_lib)</span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>N_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(X_lib)</span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>rgr_t_lib <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>,</span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(N_names), <span class="fu">length</span>(G_names), <span class="fu">length</span>(K_names)),</span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimnames =</span> <span class="fu">list</span>(N_names, G_names, K_names))</span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> K_names) {</span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>  rgr_t_lib[,,k] <span class="ot">&lt;-</span> X_regress_t</span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>lib_t_CTSE_rgr <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(rgr_t_lib, true_t_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_t_CTSE_rgr, lib_t_CTSE_blk, </span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"Fraction-Regressed Bulk"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_t_CTSE_dp, lib_t_CTSE_rgr, </span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over Fraction-Regressed Bulk"</span>),</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Fraction-Regressed Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(lib_t_CTSE_bp, lib_t_CTSE_rgr, </span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(lib_prep, <span class="st">"-"</span>, lib_type, <span class="st">" RNA-seq library"</span>),</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"BayesPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Fraction-Regressed Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="pseudobulk" class="level1">
<h1>5. Pseudobulk</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>pseudobulk <span class="ot">&lt;-</span> <span class="fu">apply</span>(true_s_exp, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), sum)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>pseudobulk_Prism <span class="ot">&lt;-</span> <span class="fu">new.prism</span>(</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference=</span><span class="fu">t</span>(<span class="fu">as.matrix</span>(<span class="fu">counts</span>(sce))), </span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture=</span>pseudobulk,</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">input.type=</span><span class="st">"count.matrix"</span>, </span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell.type.labels =</span> sce<span class="sc">$</span>cellType_broad_hc, </span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell.state.labels =</span> sce<span class="sc">$</span>cellType_hc,</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">key =</span> <span class="cn">NULL</span>,</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">outlier.cut=</span><span class="fl">0.01</span>,</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.fraction=</span><span class="fl">0.1</span>,</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(pseudobulk_Prism, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"pseudobulk_Prism.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"pseudobulk_Prism.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>bp_pseudobulk <span class="ot">&lt;-</span> <span class="fu">run.prism</span>(<span class="at">prism =</span> pseudobulk_Prism, <span class="at">n.cores=</span><span class="dv">14</span>)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(bp_pseudobulk, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"bp_pseudobulk.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"bp_pseudobulk.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>dp_pseudobulk <span class="ot">&lt;-</span> <span class="fu">run.prism.Omega</span>(<span class="at">prism =</span> pseudobulk_Prism, <span class="at">Omega =</span> Omega, <span class="at">n.cores=</span><span class="dv">14</span>)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(dp_pseudobulk, <span class="at">file=</span><span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"dp_pseudobulk.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"NotebookRData/DynaPrism/"</span>, <span class="st">"dp_pseudobulk.rdata"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="fraction-estimates" class="level2">
<h2 class="anchored" data-anchor-id="fraction-estimates">5.1 Fraction Estimates</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>bp_psb_s_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_pseudobulk<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta)</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>dp_psb_s_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_pseudobulk<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>theta)</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>psb_s_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(bp_psb_s_frac, true_s_frac)</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>psb_s_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(dp_psb_s_frac, true_s_frac)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>bp_psb_s_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_psb_s_frac)</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bp_psb_s_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_state"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>bp_psb_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(bp_psb_s_frac_df<span class="sc">$</span>cell_state))</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>bp_psb_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">factor</span>(bp_psb_s_frac_df<span class="sc">$</span>cell_state,</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bp_psb_s_frac_df<span class="sc">$</span>cell_state)))</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>dp_psb_s_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dp_psb_s_frac)</span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dp_psb_s_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_state"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>dp_psb_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(dp_psb_s_frac_df<span class="sc">$</span>cell_state))</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>dp_psb_s_frac_df<span class="sc">$</span>cell_state <span class="ot">&lt;-</span> <span class="fu">factor</span>(dp_psb_s_frac_df<span class="sc">$</span>cell_state,</span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(dp_psb_s_frac_df<span class="sc">$</span>cell_state)))</span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>bp_psb_s_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>dp_psb_s_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">")"</span>)</span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>combined_psb_s_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bp_psb_s_frac_df, dp_psb_s_frac_df, true_s_frac_df[,<span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_state"</span>, <span class="st">"Fraction"</span>, <span class="st">"Source"</span>)])</span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.character</span>(<span class="fu">unique</span>(combined_psb_s_df<span class="sc">$</span>Sample)))[<span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)]</span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>combined_psb_s_df <span class="ot">&lt;-</span> combined_psb_s_df[combined_psb_s_df<span class="sc">$</span>Sample <span class="sc">%in%</span> samples, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_psb_s_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> Fraction, <span class="at">x =</span> Source, <span class="at">fill =</span> cell_state)) <span class="sc">+</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> state_colors) <span class="sc">+</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(Sample <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">"free_x"</span>, <span class="at">space =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="co"># Use a cleaner base theme</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove y-axis text and ticks</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate the Sample labels (strips) on the right to be horizontal</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>),</span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate x-axis labels if they start to overlap</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: adjust the spacing between facets</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"lines"</span>)</span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co">#bp_t_frac &lt;- as.table(bp_pseudobulk@posterior.initial.cellType@theta)</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>bp_psb_t_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(bp_pseudobulk<span class="sc">@</span>posterior.theta_f<span class="sc">@</span>theta)</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="co">#dp_t_frac &lt;- as.table(dp_pseudobulk@posterior.initial.cellType@theta)</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>dp_psb_t_frac <span class="ot">&lt;-</span> <span class="fu">as.table</span>(dp_pseudobulk<span class="sc">@</span>posterior.theta_f<span class="sc">@</span>theta)</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(bp_psb_t_frac, true_t_frac)</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp <span class="ot">&lt;-</span> <span class="fu">eval_frac</span>(dp_psb_t_frac, true_t_frac)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>bp_psb_t_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(bp_psb_t_frac)</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bp_psb_t_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_type"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>bp_psb_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(bp_psb_t_frac_df<span class="sc">$</span>cell_type))</span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>bp_psb_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(bp_psb_t_frac_df<span class="sc">$</span>cell_type,</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bp_psb_t_frac_df<span class="sc">$</span>cell_type)))</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>dp_psb_t_frac_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dp_psb_t_frac)</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dp_psb_t_frac_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_type"</span>, <span class="st">"Fraction"</span>)</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>dp_psb_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(dp_psb_t_frac_df<span class="sc">$</span>cell_type))</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>dp_psb_t_frac_df<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(dp_psb_t_frac_df<span class="sc">$</span>cell_type,</span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(dp_psb_t_frac_df<span class="sc">$</span>cell_type)))</span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>bp_psb_t_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="st">"BayesPrism"</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>dp_psb_t_frac_df<span class="sc">$</span>Source <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">")"</span>)</span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>combined_psb_t_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bp_psb_t_frac_df, dp_psb_t_frac_df, true_t_frac_df[,<span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"cell_type"</span>, <span class="st">"Fraction"</span>, <span class="st">"Source"</span>)])</span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">as.character</span>(<span class="fu">unique</span>(combined_psb_t_df<span class="sc">$</span>Sample)))[<span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)]</span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>combined_psb_t_df <span class="ot">&lt;-</span> combined_psb_t_df[combined_psb_t_df<span class="sc">$</span>Sample <span class="sc">%in%</span> samples, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_psb_t_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> Fraction, <span class="at">x =</span> Source, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> type_colors) <span class="sc">+</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(Sample <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">"free_x"</span>, <span class="at">space =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="co"># Use a cleaner base theme</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove y-axis text and ticks</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate the Sample labels (strips) on the right to be horizontal</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>),</span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate x-axis labels if they start to overlap</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: adjust the spacing between facets</span></span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"lines"</span>)</span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ctse-estimates" class="level2">
<h2 class="anchored" data-anchor-id="ctse-estimates">5.2 CTSE Estimates</h2>
<section id="cell-state-2" class="level3">
<h3 class="anchored" data-anchor-id="cell-state-2">5.2.1 Cell-State</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>bp_s_exp <span class="ot">&lt;-</span> bp_pseudobulk<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>Z</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>dp_s_exp <span class="ot">&lt;-</span> dp_pseudobulk<span class="sc">@</span>posterior.initial.cellState<span class="sc">@</span>Z</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>psb_s_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(bp_s_exp, true_s_exp, <span class="at">markers_list =</span> state_marker_list)</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>psb_s_CTSE_dp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(dp_s_exp, true_s_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_s_CTSE_dp, psb_s_CTSE_bp, </span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over BayesPrism"</span>),</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="st">"Pseudobulk"</span>,</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> state_colors, </span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ExpSpe</span>(psb_s_CTSE_dp, psb_s_CTSE_bp, gene_pressure, </span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"State-Level Expression Specificity"</span>,</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") on Pseudobulk"</span>),</span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="plain-bulk-2" class="level4">
<h4 class="anchored" data-anchor-id="plain-bulk-2">5.2.1.1 Plain Bulk</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>psb_X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(pseudobulk_Prism<span class="sc">@</span>mixture)</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>psb_X_cpm <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X, <span class="dv">1</span>, <span class="fu">rowSums</span>(X), <span class="st">"/"</span>) <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(psb_X)</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>N_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(psb_X)</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> cell_states</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>psb_s_exp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, </span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(N_names), <span class="fu">length</span>(G_names), <span class="fu">length</span>(K_names)),</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimnames =</span> <span class="fu">list</span>(N_names, G_names, K_names))</span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> K_names) {</span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>  psb_s_exp[,,k] <span class="ot">&lt;-</span> psb_X</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>psb_s_CTSE_blk <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(psb_s_exp, true_s_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_s_CTSE_dp, psb_s_CTSE_blk, </span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over Plain Bulk"</span>),</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span>  <span class="fu">paste0</span>(<span class="st">"Pseudobulk"</span>),</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> state_colors, </span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_s_CTSE_bp, psb_s_CTSE_blk, </span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Pseudobulk"</span>),</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> state_colors, </span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"BayesPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="cell-type-2" class="level3">
<h3 class="anchored" data-anchor-id="cell-type-2">5.2.2 Cell-Type</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>bp_t_exp <span class="ot">&lt;-</span> bp_pseudobulk<span class="sc">@</span>posterior.initial.cellType<span class="sc">@</span>Z</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>dp_t_exp <span class="ot">&lt;-</span> dp_pseudobulk<span class="sc">@</span>posterior.initial.cellType<span class="sc">@</span>Z</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(bp_t_exp, true_t_exp, <span class="at">markers_list =</span> type_marker_list)</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(dp_t_exp, true_t_exp, <span class="at">markers_list =</span> type_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp<span class="sc">$</span>ExpSCorr_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
0.8944153 0.7413856 0.6489968 0.9609809 0.7671942 0.7224668 0.5770082 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp<span class="sc">$</span>ExpSCorr_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
0.8261847 0.4096275 0.5300689 0.9278746 0.4236591 0.5082335 0.1747955 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp<span class="sc">$</span>CvSpe_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Inhib       Oligo         OPC       Excit       Astro   EndoMural 
-0.04047964  0.22665213  0.05458172  0.21135910  0.20139009  0.15439792 
      Micro 
 0.17981826 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp<span class="sc">$</span>CvSpe_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
0.1309752 0.1644233 0.2138138 0.1762840 0.3012225 0.2366783 0.2002221 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp<span class="sc">$</span>ExpSpe_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9963243</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp<span class="sc">$</span>ExpSpe_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.717015</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp<span class="sc">$</span>ExpMAE_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
 6.176335 12.805217 14.265272  3.213446 19.460135 20.044596 20.377831 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp<span class="sc">$</span>ExpMAE_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
11.327838 46.993310 19.474772  7.103677 79.113933 44.656661 87.786373 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_bp<span class="sc">$</span>ExpRMSE_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
 8.596535 19.728197 19.761918  5.889907 29.605979 30.353877 29.018054 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_dp<span class="sc">$</span>ExpRMSE_Summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Inhib     Oligo       OPC     Excit     Astro EndoMural     Micro 
 14.21255  70.12801  24.93739  10.35026 130.59787  72.24532 154.08422 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_t_CTSE_dp, psb_t_CTSE_bp, </span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over BayesPrism"</span>),</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="st">"Pseudobulk"</span>,</span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ExpSpe</span>(psb_t_CTSE_dp, psb_t_CTSE_bp, gene_pressure, </span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Type-Level Expression Specificity"</span>,</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") on Pseudobulk"</span>),</span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"BayesPrism"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="plain-bulk-3" class="level4">
<h4 class="anchored" data-anchor-id="plain-bulk-3">5.2.2.1 Plain Bulk</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>psb_X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(pseudobulk_Prism<span class="sc">@</span>mixture)</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>psb_X_cpm <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X, <span class="dv">1</span>, <span class="fu">rowSums</span>(X), <span class="st">"/"</span>) <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(psb_X)</span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>N_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(psb_X)</span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> cell_types</span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>psb_t_exp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, </span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(N_names), <span class="fu">length</span>(G_names), <span class="fu">length</span>(K_names)),</span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimnames =</span> <span class="fu">list</span>(N_names, G_names, K_names))</span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> K_names) {</span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>  psb_t_exp[,,k] <span class="ot">&lt;-</span> psb_X</span>
<span id="cb205-14"><a href="#cb205-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_blk <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(psb_t_exp, true_t_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_t_CTSE_dp, psb_t_CTSE_blk, </span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over Plain Bulk"</span>),</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span>  <span class="fu">paste0</span>(<span class="st">"Pseudobulk"</span>),</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_t_CTSE_bp, psb_t_CTSE_blk, </span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Pseudobulk"</span>),</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"BayesPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-33-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fraction-regressed-bulk-1" class="level4">
<h4 class="anchored" data-anchor-id="fraction-regressed-bulk-1">5.2.2.2 Fraction-Regressed Bulk</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>common_n <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">rownames</span>(psb_X), <span class="fu">rownames</span>(true_t_frac))</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>psb_X <span class="ot">&lt;-</span> psb_X[common_n, ]</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>theta_t <span class="ot">&lt;-</span> true_t_frac[common_n, ]</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>psb_beta_hat_t <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(theta_t) <span class="sc">%*%</span> theta_t) <span class="sc">%*%</span> <span class="fu">t</span>(theta_t) <span class="sc">%*%</span> psb_X</span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a>psb_X_hat_t <span class="ot">&lt;-</span> theta_t <span class="sc">%*%</span> psb_beta_hat_t</span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a>psb_mu_g <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(psb_X)</span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate X_regress: X_observed - X_predicted + mu_g</span></span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>psb_X_regress_t <span class="ot">&lt;-</span> psb_X <span class="sc">-</span> psb_X_hat_t</span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>psb_X_regress_t <span class="ot">&lt;-</span> <span class="fu">sweep</span>(psb_X_regress_t, <span class="dv">2</span>, psb_mu_g, <span class="st">"+"</span>)</span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a>psb_X_regress_t[psb_X_regress_t <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>K_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(theta_t)</span>
<span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a>G_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(psb_X)</span>
<span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a>N_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(psb_X)</span>
<span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a>rgr_t_psb <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>,</span>
<span id="cb211-21"><a href="#cb211-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(N_names), <span class="fu">length</span>(G_names), <span class="fu">length</span>(K_names)),</span>
<span id="cb211-22"><a href="#cb211-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimnames =</span> <span class="fu">list</span>(N_names, G_names, K_names))</span>
<span id="cb211-23"><a href="#cb211-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-24"><a href="#cb211-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> K_names) {</span>
<span id="cb211-25"><a href="#cb211-25" aria-hidden="true" tabindex="-1"></a>  rgr_t_psb[,,k] <span class="ot">&lt;-</span> psb_X_regress_t</span>
<span id="cb211-26"><a href="#cb211-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>psb_t_CTSE_rgr <span class="ot">&lt;-</span> <span class="fu">eval_CTSE</span>(rgr_t_lib, true_t_exp, <span class="at">markers_list =</span> state_marker_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_t_CTSE_rgr, psb_t_CTSE_blk, </span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="st">"Pseudobulk"</span>,</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"Fraction-Regressed Bulk"</span>, <span class="at">ori_name =</span> <span class="st">"Plain Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_t_CTSE_dp, psb_t_CTSE_rgr, </span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"DynaPrism (β = "</span>, dp_res<span class="sc">@</span>control_param<span class="sc">$</span>gibbs.control<span class="sc">$</span>beta, <span class="st">") Performance Gain over Fraction-Regressed Bulk"</span>),</span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="st">"Pseudobulk"</span>,</span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"DynaPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Fraction-Regressed Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-36-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_DeltaCTSE</span>(psb_t_CTSE_bp, psb_t_CTSE_rgr, </span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">#title = paste0("BayesPrism Performance Gain"),</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="st">"Pseudobulk"</span>,</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">group_colors =</span> type_colors, </span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod_name =</span> <span class="st">"BayesPrism"</span>, <span class="at">ori_name =</span> <span class="st">"Fraction-Regressed Bulk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DynaPrism_files/figure-html/unnamed-chunk-36-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>